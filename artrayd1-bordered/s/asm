          AREA |C$$code|, CODE, READONLY

; constants
width             * 32
height            * 32
period            * 3
wordsperrow       * 2
nwords            * 892
nframes           * 49
active_x          * 16
active_y          * 16

; Workspace for changing the hourglass rendition
                  ^ 0, r12
hg_framenum       # 4                         ; frame number
hg_percentage     # 4                         ; percentage to show (N/I)
hg_leds           # 4                         ; LED flags (N/I)
hg_oldpointer     # 4                         ; Old pointer configuration
hg_oldcolours     # 4 * 3                     ; Old palette entries
hg_word           # 12                        ; OS_Word block
hg_currentdata    # 4 * wordsperrow * height  ; Current data for the hourglass
hg_workspacesize  * :INDEX: @                 ; Size of this workspace

; SWI numbers
XOS_Byte          * 0x20006
XOS_Word          * 0x20007
XOS_ReadPalette   * 0x2002F

; -------------------------------------------------
        MACRO
$label  SIGNATURE
        ALIGN   4
        =       "$label",0
        ALIGN   4
        DCD     &FF000000+(:LEN:"$label"+4):AND::NOT:3
$label
        MEND

; Data for the rows of the hourglass
rowdata
          DCD     &aa800000, &000002aa
          DCD     &55680000, &00002955
          DCD     &55560000, &00009555
          DCD     &aa558000, &000255aa
          DCD     &55558000, &00095555
          DCD     &55558000, &00025555
          DCD     &55580000, &00002555
          DCD     &55600000, &00000955
          DCD     &a5800000, &0000025a
          DCD     &96000000, &00000096
          DCD     &25800000, &00000258
          DCD     &09600000, &00000960
          DCD     &02580000, &00002580
          DCD     &00960000, &00009600
          DCD     &00258000, &00025800
          DCD     &00098000, &00026000
          DCD     &aa898000, &000962aa
          DCD     &55698000, &00096955
          DCD     &a9558000, &0009555a
          DCD     &02a58000, &000956a0
          DCD     &2a958000, &000256a8
          DCD     &95560000, &00009556
          DCD     &aa958000, &000256aa
          DCD     &5aa58000, &00095655
          DCD     &55800000, &00000255
          DCD     &56000000, &00000095
          DCD     &aaa58000, &00095aaa
          DCD     &65800000, &0000025a
          DCD     &69600000, &00000962
          DCD     &62580000, &00002582
          DCD     &80960000, &00009600
          DCD     &00258000, &00095800
          DCD     &aa958000, &000956aa
          DCD     &a5800000, &00000259
          DCD     &89600000, &00000969
          DCD     &82580000, &00002589
          DCD     &80960000, &00009609
          DCD     &80258000, &00025809
          DCD     &80098000, &00026009
          DCD     &6a898000, &000962a9
          DCD     &69558000, &00095559
          DCD     &82a58000, &000956a2
          DCD     &62a58000, &000956a9
          DCD     &5a958000, &000256a5
          DCD     &55a58000, &00096a55
          DCD     &a9558000, &000256aa
          DCD     &55a58000, &00095655
          DCD     &55a98000, &00096a55
          DCD     &aaa58000, &000268aa
          DCD     &a0098000, &00026009
          DCD     &5a898000, &000962a5
          DCD     &aa258000, &000260aa
          DCD     &02958000, &00025a00
          DCD     &a9560000, &000095aa
          DCD     &6a258000, &000258a9
          DCD     &55a98000, &00026255
          DCD     &55598000, &00096955
          DCD     &55558000, &00096555
          DCD     &aa098000, &000260aa
          DCD     &00a58000, &00025800
          DCD     &0a560000, &00009680
          DCD     &a5580000, &0000256a
          DCD     &6a960000, &000096a9
          DCD     &55558000, &00025955
          DCD     &02960000, &00009600
          DCD     &29580000, &000025a0
          DCD     &95600000, &0000095a
          DCD     &6a580000, &000025a9
          DCD     &aa580000, &000025aa
          DCD     &55568000, &00009555
          DCD     &aa956000, &000256aa
          DCD     &00296000, &00025600
          DCD     &aa956000, &000255aa
          DCD     &55556000, &00025955
          DCD     &55696000, &00025a95
          DCD     &aa896000, &0002582a
          DCD     &00258000, &00009600
          DCD     &00a58000, &00009580
          DCD     &02560000, &00002580
          DCD     &09580000, &00000960
          DCD     &25a00000, &00000258
          DCD     &25800000, &00000a58
          DCD     &09600000, &00002560
          DCD     &a9580000, &000095aa
          DCD     &55560000, &00025555
          DCD     &55560000, &00029555
          DCD     &aa956000, &000096aa
          DCD     &00295800, &00009580
          DCD     &a0a95800, &0000956a
          DCD     &5a555800, &00009a55
          DCD     &55555800, &000098a5
          DCD     &aaaa5800, &0000960a
          DCD     &00096000, &00009600
          DCD     &00256000, &00002580
          DCD     &00958000, &00000960
          DCD     &025a0000, &00000258
          DCD     &09600000, &00000258
          DCD     &25800000, &00000096
          DCD     &96000000, &00000256
          DCD     &96000000, &00002968
          DCD     &25800000, &00009580
          DCD     &a5600000, &000256aa
          DCD     &55580000, &00095555
          DCD     &55560000, &00095555
          DCD     &55560000, &00255555
          DCD     &aa800000, &000000aa
          DCD     &55680000, &00000255
          DCD     &55568000, &00000955
          DCD     &aa956000, &0000095a
          DCD     &00295800, &0000095a
          DCD     &a0025600, &00002595
          DCD     &5aaa9580, &000025a9
          DCD     &55555580, &00002582
          DCD     &a9555600, &00000960
          DCD     &02aa9600, &00000960
          DCD     &00009600, &00000258
          DCD     &000a5800, &00000258
          DCD     &00a56000, &00000096
          DCD     &0a558000, &00000096
          DCD     &255a0000, &00000026
          DCD     &95a00000, &00000096
          DCD     &98000000, &00002958
          DCD     &96000000, &000295a0
          DCD     &96000000, &00095a02
          DCD     &55800000, &00255aa9
          DCD     &55800000, &00955555
          DCD     &55600000, &00955555
          DCD     &55600000, &02555555
          DCD     &55580000, &02555555
          DCD     &55580000, &00955555
          DCD     &55600000, &00255555
          DCD     &55600000, &00095555
          DCD     &55600000, &00029555
          DCD     &55800000, &00002955
          DCD     &aa000000, &000002aa
          DCD     &55568000, &0000955a
          DCD     &aa956000, &000096a0
          DCD     &00295800, &000095a0
          DCD     &a0aa5800, &0000955a
          DCD     &55555800, &000096a9
          DCD     &aaaa5800, &00009602
          DCD     &00096000, &00002580
          DCD     &02560000, &00000258
          DCD     &29680000, &00000096
          DCD     &95800000, &00000096
          DCD     &96000000, &00000258
          DCD     &96000000, &00002960
          DCD     &a5600000, &000255aa
          DCD     &55580000, &00029555
          DCD     &55a00000, &00002955
          DCD     &02958000, &00096800
          DCD     &a9558000, &00095aaa
          DCD     &55658000, &00095555
          DCD     &56a58000, &00096955
          DCD     &a8258000, &000962aa
          DCD     &00960000, &00025800
          DCD     &02560000, &00025600
          DCD     &09580000, &00009580
          DCD     &09600000, &00002960
          DCD     &96800000, &00000096
          DCD     &25600000, &00000258
          DCD     &aa560000, &0000255a
          DCD     &55558000, &00009555
          DCD     &55556000, &00025555
          DCD     &55680000, &00002a55
          DCD     &95600000, &00029556
          DCD     &29600000, &000956a8
          DCD     &a5580000, &00256800
          DCD     &56580000, &0095800a
          DCD     &5a580000, &0096aaa5
          DCD     &a2580000, &00955555
          DCD     &02580000, &0095556a
          DCD     &09600000, &0096aa80
          DCD     &09600000, &00258000
          DCD     &25800000, &00256800
          DCD     &96000000, &000a5600
          DCD     &96000000, &000095a0
          DCD     &96000000, &00000296
          DCD     &25680000, &00000096
          DCD     &0a568000, &00000096
          DCD     &00956000, &00000098
          DCD     &aa555800, &00000256
          DCD     &55555800, &00000955
          DCD     &55555600, &00000955
          DCD     &55555600, &00002555
          DCD     &55555800, &00002555
          DCD     &55556000, &00000955
          DCD     &a0000000, &000002aa
          DCD     &58000000, &00002955
          DCD     &58000000, &00029555
          DCD     &56000000, &000956a9
          DCD     &56000000, &00256809
          DCD     &a5800000, &00958025
          DCD     &25800000, &025a0296
          DCD     &25800000, &09582958
          DCD     &26000000, &096a9560
          DCD     &96000000, &09555680
          DCD     &96000000, &09556800
          DCD     &98000000, &025a8000
          DCD     &58000000, &025a8002
          DCD     &58000000, &00956a02
          DCD     &58000000, &002555aa
          DCD     &96a80000, &000aa556
          DCD     &2556a000, &00000a96
          DCD     &8a555800, &00000025
          DCD     &80aa5600, &00000025
          DCD     &aaa95580, &00000026
          DCD     &55555580, &00000025
          DCD     &55555560, &00000095
          DCD     &55555560, &00000255
          DCD     &55555580, &00000255
          DCD     &55555600, &00000255
          DCD     &55555800, &00000095
          DCD     &55556000, &00000095
          DCD     &55568000, &00000025
          DCD     &55680000, &00000009
          DCD     &aa800000, &00000002
          DCD     &00000000, &00000280
          DCD     &00000000, &00002960
          DCD     &00000000, &00029558
          DCD     &00000000, &00095556
          DCD     &80000000, &00256a55
          DCD     &60000000, &00968969
          DCD     &60000000, &02580969
          DCD     &60000000, &09582589
          DCD     &60000000, &09602582
          DCD     &60000000, &25809602
          DCD     &60000000, &258a5802
          DCD     &60000000, &96a56002
          DCD     &60000000, &95568002
          DCD     &68000000, &95580002
          DCD     &56aaaa00, &25680002
          DCD     &95555580, &0956aaa8
          DCD     &2aa95560, &02955556
          DCD     &8aa55558, &002aaaa5
          DCD     &a5555556, &00000009
          DCD     &55555556, &00000009
          DCD     &55555558, &00000009
          DCD     &55555560, &00000009
          DCD     &55555580, &00000009
          DCD     &55555600, &00000009
          DCD     &55555800, &00000002
          DCD     &95556000, &00000000
          DCD     &25568000, &00000000
          DCD     &09a80000, &00000000
          DCD     &02000000, &00000000
          DCD     &00000000, &00000000
          DCD     &00000000, &0002a000
          DCD     &00000000, &00095a00
          DCD     &00000000, &002555a0
          DCD     &00000000, &00955558
          DCD     &00000000, &025a5a58
          DCD     &00000000, &09625896
          DCD     &00000000, &25825826
          DCD     &00000000, &25826026
          DCD     &800aaa00, &96096025
          DCD     &80a555a0, &96096009
          DCD     &6a555558, &96258009
          DCD     &555a5556, &96260002
          DCD     &aaa55556, &96960028
          DCD     &8a555556, &95580a96
          DCD     &65555556, &956aa555
          DCD     &55555556, &255555a9
          DCD     &55555556, &0a556a02
          DCD     &55555556, &00aa8002
          DCD     &95555558, &00000000
          DCD     &95555560, &00000000
          DCD     &25555560, &00000000
          DCD     &25555580, &00000000
          DCD     &09555600, &00000000
          DCD     &02555800, &00000000
          DCD     &00a56000, &00000000
          DCD     &000a8000, &00000000
          DCD     &00000000, &00aaa000
          DCD     &00000000, &02555800
          DCD     &00000000, &09555600
          DCD     &0002aa80, &0956a580
          DCD     &00295560, &25a60960
          DCD     &00955558, &25a58960
          DCD     &02555556, &96258258
          DCD     &a9695556, &96258096
          DCD     &55a55556, &96258025
          DCD     &56255556, &96258009
          DCD     &a8955556, &96258002
          DCD     &82555556, &9626002a
          DCD     &69555556, &96260095
          DCD     &55555556, &96960255
          DCD     &95555556, &9698296a
          DCD     &25555556, &955a9580
          DCD     &09555558, &25595600
          DCD     &09555558, &09556800
          DCD     &02555560, &02aa8000
          DCD     &00955560, &00000000
          DCD     &00255580, &00000000
          DCD     &000aaa00, &00000000
          DCD     &00002800, &00000000
          DCD     &002a9600, &00000000
          DCD     &00955580, &00000000
          DCD     &02555560, &00000000
          DCD     &09555560, &002a0000
          DCD     &09555558, &0a95a000
          DCD     &25955558, &25555800
          DCD     &26955556, &256a5680
          DCD     &96955556, &9560a56a
          DCD     &58955556, &96580955
          DCD     &60955556, &96960295
          DCD     &82555556, &9696002a
          DCD     &aa555556, &96260002
          DCD     &55555556, &96258009
          DCD     &55555556, &96258025
          DCD     &a9555556, &96258096
          DCD     &02955556, &96098098
          DCD     &00255558, &25898258
          DCD     &000a56a0, &25898960
          DCD     &0000a800, &0965a560
          DCD     &00000000, &09555580
          DCD     &00000000, &02555600
          DCD     &00000000, &0095a800
          DCD     &00000000, &002a0000
          DCD     &00280000, &00000000
          DCD     &02968000, &00000000
          DCD     &09556000, &00000000
          DCD     &25555800, &00000000
          DCD     &95555600, &00000000
          DCD     &95555580, &00000000
          DCD     &59555560, &00000002
          DCD     &59555558, &00000002
          DCD     &69555556, &00000002
          DCD     &69555556, &00aaa809
          DCD     &65555556, &025556a9
          DCD     &a5555556, &29555555
          DCD     &25555556, &95aaaa56
          DCD     &95555558, &95a000a8
          DCD     &55555560, &95580002
          DCD     &6aa55680, &96560009
          DCD     &600aa800, &96a58009
          DCD     &80000000, &96096009
          DCD     &80000000, &25896025
          DCD     &80000000, &25825825
          DCD     &80000000, &09609825
          DCD     &80000000, &09589625
          DCD     &00000000, &025a2696
          DCD     &00000000, &0095a556
          DCD     &00000000, &00255558
          DCD     &00000000, &000955a0
          DCD     &00000000, &0002a600
          DCD     &00000000, &00000800
          DCD     &55568000, &00000009
          DCD     &55556000, &00000025
          DCD     &55555600, &00000095
          DCD     &55555580, &00000096
          DCD     &95555560, &00000096
          DCD     &25555560, &00000096
          DCD     &25555558, &00000096
          DCD     &09555558, &00000026
          DCD     &89555560, &00000025
          DCD     &a5555580, &00000025
          DCD     &a5555600, &00000025
          DCD     &25556800, &0002aa96
          DCD     &95aa8000, &00295558
          DCD     &5a000000, &009556a2
          DCD     &58000000, &0256a802
          DCD     &58000000, &02580002
          DCD     &98000000, &096a0000
          DCD     &98000000, &2555a000
          DCD     &96000000, &25555a00
          DCD     &96000000, &096a5580
          DCD     &96000000, &0960a560
          DCD     &96000000, &02580a58
          DCD     &96000000, &00968096
          DCD     &96000000, &00256825
          DCD     &58000000, &000956a9
          DCD     &60000000, &00029555
          DCD     &60000000, &00002955
          DCD     &80000000, &000002aa
          DCD     &55680000, &00000955
          DCD     &55568000, &00002555
          DCD     &55556000, &00009555
          DCD     &55555800, &00009555
          DCD     &55555800, &000096aa
          DCD     &55555800, &00002582
          DCD     &55556000, &00002582
          DCD     &95558000, &00000960
          DCD     &95560000, &00000258
          DCD     &95580000, &00000096
          DCD     &09600000, &00025600
          DCD     &02580000, &00096800
          DCD     &02580000, &00258000
          DCD     &00960000, &00258000
          DCD     &a0960000, &0025aaaa
          DCD     &5a960000, &00255555
          DCD     &55960000, &00256aaa
          DCD     &a9560000, &00256800
          DCD     &2a560000, &000956aa
          DCD     &95580000, &00029555
          DCD     &55600000, &00002955
          DCD     &55800000, &00255555
          DCD     &56000000, &000956aa
          DCD     &56000000, &000255a2
          DCD     &98000000, &0000a958
          DCD     &25680000, &00000026
          DCD     &00009600, &00000960
          DCD     &0aaa9600, &00000960
          DCD     &a5555580, &00002580
          DCD     &55aa9580, &0000258a
          DCD     &6a025600, &000025a5
          DCD     &80295800, &00000955
          DCD     &2a956000, &0000095a
          DCD     &95568000, &00000956
          DCD     &55580000, &00255555
          DCD     &55560000, &00955555
          DCD     &55800000, &00095555
          DCD     &95800000, &000255aa
          DCD     &96000000, &0000a560
          DCD     &96000000, &00000958
          DCD     &25a00000, &00000096
          DCD     &095a0000, &00000096
          DCD     &02958000, &00000258
          DCD     &00256000, &00000258
          DCD     &00095800, &00000960
          DCD     &00025800, &00002580
          DCD     &2aaa9800, &00002580
          DCD     &95555600, &0000960a
          DCD     &55555600, &00009625
          DCD     &6aaa5600, &00009695
          DCD     &80295800, &0000255a
          DCD     &aa956000, &00002568
          DCD     &55568000, &00002556
          DCD     &55558000, &00255555
          DCD     &55580000, &00025555
          DCD     &55600000, &0000955a
          DCD     &a5800000, &00002560
          DCD     &00026000, &00009600
          DCD     &aaaa5800, &0002582a
          DCD     &55555800, &00025a95
          DCD     &aaa95800, &00009556
          DCD     &00295800, &00009568
          DCD     &aa956000, &000095aa
          DCD     &aa580000, &0000255a
          DCD     &00096000, &00025800
          DCD     &aa896000, &000262aa
          DCD     &55696000, &00026955
          DCD     &a9556000, &0002555a
          DCD     &02a56000, &000256a0
          DCD     &59580000, &00002555
          DCD     &a9600000, &0000095a

; Data for deltas between frames
deltas
          ; frame 0
          DCD     0, 0
          DCD     8, 8
          DCD     16, 16
          DCD     24, 24
          DCD     32, 32
          DCD     40, 32
          DCD     48, 32
          DCD     56, 32
          DCD     64, 40
          DCD     72, 40
          DCD     80, 16
          DCD     88, 48
          DCD     96, 56
          DCD     104, 64
          DCD     112, 72
          DCD     120, 72
          DCD     128, 72
          DCD     136, 72
          DCD     144, 80
          DCD     152, 88
          DCD     160, 96
          DCD     168, 104
          DCD     176, 112
          DCD     184, 120
          DCD     192, 128
          DCD     200, 136
          DCD     208, 144
          DCD     216, 152
          DCD     224, 160
          DCD     232, 168
          DCD     240, 8
          DCD     248, 0
          DCD     -1, -1
          ; frame 1
          DCD     -1, -1
          ; frame 2
          DCD     24, 176
          DCD     32, 184
          DCD     104, 192
          DCD     112, 200
          DCD     120, 200
          DCD     128, 200
          DCD     -1, -1
          ; frame 3
          DCD     -1, -1
          ; frame 4
          DCD     32, 208
          DCD     136, 200
          DCD     144, 216
          DCD     152, 224
          DCD     160, 232
          DCD     168, 240
          DCD     -1, -1
          ; frame 5
          DCD     -1, -1
          ; frame 6
          DCD     32, 248
          DCD     40, 256
          DCD     144, 264
          DCD     152, 272
          DCD     160, 280
          DCD     168, 288
          DCD     176, 296
          DCD     184, 304
          DCD     192, 312
          DCD     208, 320
          DCD     216, 328
          DCD     -1, -1
          ; frame 7
          DCD     -1, -1
          ; frame 8
          DCD     216, 336
          DCD     224, 344
          DCD     232, 16
          DCD     -1, -1
          ; frame 9
          DCD     -1, -1
          ; frame 10
          DCD     56, 352
          DCD     64, 360
          DCD     208, 32
          DCD     216, 368
          DCD     224, 40
          DCD     -1, -1
          ; frame 11
          DCD     -1, -1
          ; frame 12
          DCD     56, 376
          DCD     64, 384
          DCD     72, 360
          DCD     184, 392
          DCD     192, 400
          DCD     216, 32
          DCD     -1, -1
          ; frame 13
          DCD     -1, -1
          ; frame 14
          DCD     64, 408
          DCD     72, 416
          DCD     80, 424
          DCD     176, 432
          DCD     184, 440
          DCD     192, 448
          DCD     200, 456
          DCD     -1, -1
          ; frame 15
          DCD     -1, -1
          ; frame 16
          DCD     64, 464
          DCD     72, 472
          DCD     80, 480
          DCD     88, 488
          DCD     168, 496
          DCD     176, 504
          DCD     184, 40
          DCD     192, 32
          DCD     200, 32
          DCD     -1, -1
          ; frame 17
          DCD     -1, -1
          ; frame 18
          DCD     72, 112
          DCD     80, 512
          DCD     88, 520
          DCD     96, 528
          DCD     160, 536
          DCD     168, 16
          DCD     176, 40
          DCD     -1, -1
          ; frame 19
          DCD     -1, -1
          ; frame 20
          DCD     80, 104
          DCD     88, 96
          DCD     96, 88
          DCD     104, 80
          DCD     112, 72
          DCD     120, 72
          DCD     128, 72
          DCD     136, 72
          DCD     144, 80
          DCD     152, 88
          DCD     160, 544
          DCD     -1, -1
          ; frame 21
          DCD     -1, -1
          ; frame 22
          DCD     -1, -1
          ; frame 23
          DCD     -1, -1
          ; frame 24
          DCD     -1, -1
          ; frame 25
          DCD     -1, -1
          ; frame 26
          DCD     -1, -1
          ; frame 27
          DCD     -1, -1
          ; frame 28
          DCD     -1, -1
          ; frame 29
          DCD     -1, -1
          ; frame 30
          DCD     16, 552
          DCD     24, 560
          DCD     32, 568
          DCD     40, 576
          DCD     48, 584
          DCD     56, 592
          DCD     64, 600
          DCD     72, 608
          DCD     80, 616
          DCD     88, 624
          DCD     96, 632
          DCD     104, 640
          DCD     144, 648
          DCD     152, 656
          DCD     160, 664
          DCD     168, 672
          DCD     176, 672
          DCD     184, 32
          DCD     224, 32
          DCD     232, 680
          DCD     -1, -1
          ; frame 31
          DCD     24, 688
          DCD     32, 696
          DCD     40, 704
          DCD     48, 712
          DCD     56, 720
          DCD     64, 728
          DCD     72, 736
          DCD     80, 744
          DCD     88, 752
          DCD     96, 760
          DCD     104, 768
          DCD     112, 776
          DCD     136, 784
          DCD     144, 792
          DCD     152, 800
          DCD     160, 808
          DCD     168, 816
          DCD     176, 824
          DCD     184, 832
          DCD     192, 832
          DCD     200, 832
          DCD     208, 832
          DCD     216, 832
          DCD     224, 824
          DCD     -1, -1
          ; frame 32
          DCD     0, 840
          DCD     8, 848
          DCD     16, 856
          DCD     24, 864
          DCD     32, 872
          DCD     40, 880
          DCD     48, 888
          DCD     56, 896
          DCD     64, 904
          DCD     72, 912
          DCD     80, 920
          DCD     88, 928
          DCD     96, 936
          DCD     104, 944
          DCD     112, 952
          DCD     120, 960
          DCD     128, 784
          DCD     136, 968
          DCD     144, 976
          DCD     152, 984
          DCD     160, 992
          DCD     168, 1000
          DCD     176, 1008
          DCD     184, 1008
          DCD     192, 1016
          DCD     200, 1024
          DCD     208, 1032
          DCD     216, 1040
          DCD     224, 1048
          DCD     232, 1056
          DCD     240, 1064
          DCD     248, 1072
          DCD     -1, -1
          ; frame 33
          DCD     0, 0
          DCD     8, 8
          DCD     16, 1080
          DCD     24, 1088
          DCD     32, 1096
          DCD     40, 1104
          DCD     48, 712
          DCD     56, 1112
          DCD     64, 1120
          DCD     72, 1128
          DCD     80, 744
          DCD     88, 752
          DCD     96, 1136
          DCD     104, 1144
          DCD     112, 1152
          DCD     120, 72
          DCD     128, 72
          DCD     136, 1160
          DCD     144, 1168
          DCD     152, 800
          DCD     160, 1176
          DCD     168, 816
          DCD     176, 816
          DCD     184, 832
          DCD     192, 832
          DCD     200, 832
          DCD     208, 832
          DCD     216, 832
          DCD     224, 824
          DCD     232, 1184
          DCD     240, 1192
          DCD     -1, -1
          ; frame 34
          DCD     16, 680
          DCD     24, 256
          DCD     32, 1200
          DCD     40, 1208
          DCD     48, 1216
          DCD     56, 1224
          DCD     64, 1232
          DCD     72, 1240
          DCD     80, 1248
          DCD     88, 1256
          DCD     96, 1264
          DCD     104, 80
          DCD     112, 72
          DCD     136, 1272
          DCD     144, 1280
          DCD     152, 632
          DCD     160, 1288
          DCD     168, 1296
          DCD     176, 1296
          DCD     184, 1304
          DCD     192, 1304
          DCD     200, 1304
          DCD     208, 1304
          DCD     216, 1304
          DCD     224, 1304
          DCD     232, 552
          DCD     240, 1312
          DCD     248, 840
          DCD     -1, -1
          ; frame 35
          DCD     0, 1072
          DCD     8, 1064
          DCD     16, 1320
          DCD     24, 1328
          DCD     32, 1336
          DCD     40, 1344
          DCD     48, 1352
          DCD     56, 1360
          DCD     64, 1368
          DCD     72, 1376
          DCD     80, 1384
          DCD     88, 1392
          DCD     96, 1400
          DCD     104, 1408
          DCD     112, 968
          DCD     120, 1416
          DCD     128, 1152
          DCD     136, 1424
          DCD     144, 1432
          DCD     152, 1440
          DCD     160, 1448
          DCD     168, 1456
          DCD     176, 1464
          DCD     184, 1472
          DCD     192, 1472
          DCD     200, 1472
          DCD     208, 1472
          DCD     216, 1480
          DCD     224, 1488
          DCD     232, 856
          DCD     240, 848
          DCD     -1, -1
          ; frame 36
          DCD     0, 1496
          DCD     8, 1504
          DCD     16, 1512
          DCD     24, 1520
          DCD     32, 1528
          DCD     40, 1536
          DCD     48, 1544
          DCD     56, 1552
          DCD     64, 1560
          DCD     72, 1568
          DCD     80, 1576
          DCD     88, 1584
          DCD     96, 1592
          DCD     104, 1600
          DCD     112, 1608
          DCD     120, 1616
          DCD     128, 1624
          DCD     136, 1632
          DCD     144, 1640
          DCD     152, 1648
          DCD     160, 1656
          DCD     168, 1664
          DCD     176, 1664
          DCD     184, 1664
          DCD     192, 1672
          DCD     200, 1680
          DCD     208, 1688
          DCD     216, 1696
          DCD     224, 1704
          DCD     232, 1712
          DCD     240, 1720
          DCD     248, 1728
          DCD     -1, -1
          ; frame 37
          DCD     0, 1736
          DCD     8, 1744
          DCD     16, 1752
          DCD     24, 1760
          DCD     32, 1768
          DCD     40, 1776
          DCD     48, 1784
          DCD     56, 1792
          DCD     64, 1800
          DCD     72, 1808
          DCD     80, 1816
          DCD     88, 1824
          DCD     96, 1832
          DCD     104, 1840
          DCD     112, 1848
          DCD     120, 1856
          DCD     128, 1864
          DCD     136, 1872
          DCD     144, 1880
          DCD     152, 1888
          DCD     160, 1888
          DCD     168, 1896
          DCD     176, 1896
          DCD     184, 1904
          DCD     192, 1904
          DCD     200, 1912
          DCD     208, 1920
          DCD     216, 1928
          DCD     224, 1936
          DCD     232, 1944
          DCD     240, 1952
          DCD     248, 1960
          DCD     -1, -1
          ; frame 38
          DCD     0, 1968
          DCD     8, 1968
          DCD     16, 1976
          DCD     24, 1984
          DCD     32, 1992
          DCD     40, 2000
          DCD     48, 2008
          DCD     56, 2016
          DCD     64, 2016
          DCD     72, 2024
          DCD     80, 2032
          DCD     88, 2040
          DCD     96, 2048
          DCD     104, 2056
          DCD     112, 2064
          DCD     120, 2072
          DCD     128, 2080
          DCD     136, 2088
          DCD     144, 2096
          DCD     152, 2104
          DCD     160, 2112
          DCD     168, 2120
          DCD     176, 2120
          DCD     184, 2128
          DCD     192, 2136
          DCD     200, 2144
          DCD     208, 2152
          DCD     216, 2160
          DCD     224, 2168
          DCD     232, 2176
          DCD     240, 1968
          DCD     248, 1968
          DCD     -1, -1
          ; frame 39
          DCD     16, 1968
          DCD     24, 1968
          DCD     32, 1968
          DCD     40, 2184
          DCD     48, 2192
          DCD     56, 2200
          DCD     64, 2208
          DCD     72, 2216
          DCD     80, 2224
          DCD     88, 2232
          DCD     96, 2240
          DCD     104, 2248
          DCD     112, 2256
          DCD     120, 2264
          DCD     128, 2272
          DCD     136, 2280
          DCD     144, 2288
          DCD     152, 2296
          DCD     160, 2304
          DCD     168, 2312
          DCD     176, 2320
          DCD     184, 2328
          DCD     192, 2336
          DCD     200, 2344
          DCD     208, 2352
          DCD     216, 1968
          DCD     224, 1968
          DCD     232, 1968
          DCD     -1, -1
          ; frame 40
          DCD     32, 2360
          DCD     40, 2368
          DCD     48, 2376
          DCD     56, 2384
          DCD     64, 2392
          DCD     72, 2400
          DCD     80, 2408
          DCD     88, 2416
          DCD     96, 2424
          DCD     104, 2432
          DCD     112, 2440
          DCD     120, 2448
          DCD     128, 2456
          DCD     136, 2464
          DCD     144, 2472
          DCD     152, 2480
          DCD     160, 2488
          DCD     168, 2496
          DCD     176, 2504
          DCD     184, 2512
          DCD     192, 2520
          DCD     200, 2528
          DCD     208, 2536
          DCD     216, 2544
          DCD     -1, -1
          ; frame 41
          DCD     8, 2552
          DCD     16, 2560
          DCD     24, 2568
          DCD     32, 2576
          DCD     40, 2584
          DCD     48, 2592
          DCD     56, 2128
          DCD     64, 2600
          DCD     72, 2608
          DCD     80, 2608
          DCD     88, 2616
          DCD     96, 2624
          DCD     104, 2632
          DCD     112, 2640
          DCD     120, 2648
          DCD     128, 2656
          DCD     136, 2664
          DCD     144, 2672
          DCD     152, 2680
          DCD     160, 2688
          DCD     168, 2696
          DCD     176, 2704
          DCD     184, 2712
          DCD     192, 2720
          DCD     200, 2728
          DCD     208, 2736
          DCD     216, 2744
          DCD     224, 2752
          DCD     232, 2760
          DCD     240, 2768
          DCD     -1, -1
          ; frame 42
          DCD     0, 1728
          DCD     8, 1720
          DCD     16, 2776
          DCD     24, 2784
          DCD     32, 1696
          DCD     40, 2792
          DCD     48, 2800
          DCD     56, 2808
          DCD     64, 2816
          DCD     72, 2824
          DCD     80, 2832
          DCD     88, 2840
          DCD     96, 2840
          DCD     104, 2848
          DCD     112, 2856
          DCD     120, 2864
          DCD     128, 2872
          DCD     136, 2880
          DCD     144, 2888
          DCD     152, 2896
          DCD     160, 2904
          DCD     168, 2912
          DCD     176, 2920
          DCD     184, 2928
          DCD     192, 2936
          DCD     200, 2944
          DCD     208, 2952
          DCD     216, 2960
          DCD     224, 2968
          DCD     232, 2976
          DCD     240, 2984
          DCD     248, 2992
          DCD     -1, -1
          ; frame 43
          DCD     0, 0
          DCD     8, 3000
          DCD     16, 3008
          DCD     24, 3016
          DCD     32, 3024
          DCD     40, 3024
          DCD     48, 3024
          DCD     56, 3024
          DCD     64, 3032
          DCD     72, 3040
          DCD     80, 3048
          DCD     88, 3056
          DCD     96, 3064
          DCD     104, 3072
          DCD     112, 960
          DCD     120, 72
          DCD     128, 72
          DCD     136, 1160
          DCD     144, 1168
          DCD     152, 800
          DCD     160, 3080
          DCD     168, 3088
          DCD     176, 3096
          DCD     184, 3104
          DCD     192, 3112
          DCD     200, 3120
          DCD     208, 3128
          DCD     216, 3136
          DCD     224, 3144
          DCD     232, 3152
          DCD     240, 3160
          DCD     248, 0
          DCD     -1, -1
          ; frame 44
          DCD     0, 1072
          DCD     8, 1064
          DCD     16, 1056
          DCD     24, 1048
          DCD     32, 1040
          DCD     40, 1032
          DCD     48, 1024
          DCD     56, 1024
          DCD     64, 1008
          DCD     72, 1008
          DCD     80, 1000
          DCD     88, 3168
          DCD     96, 3176
          DCD     104, 3184
          DCD     112, 3192
          DCD     120, 784
          DCD     128, 1152
          DCD     136, 3200
          DCD     144, 1432
          DCD     152, 936
          DCD     160, 928
          DCD     168, 920
          DCD     176, 3208
          DCD     184, 3216
          DCD     192, 3224
          DCD     200, 3232
          DCD     208, 3240
          DCD     216, 3248
          DCD     224, 3256
          DCD     232, 3264
          DCD     240, 848
          DCD     248, 840
          DCD     -1, -1
          ; frame 45
          DCD     0, 0
          DCD     8, 3160
          DCD     16, 1184
          DCD     24, 816
          DCD     32, 3272
          DCD     48, 3280
          DCD     56, 3280
          DCD     64, 3272
          DCD     72, 3272
          DCD     80, 1040
          DCD     88, 3288
          DCD     96, 3296
          DCD     104, 3304
          DCD     112, 3312
          DCD     120, 1416
          DCD     128, 72
          DCD     136, 3320
          DCD     144, 3328
          DCD     152, 3336
          DCD     160, 3344
          DCD     168, 3352
          DCD     176, 3360
          DCD     184, 3368
          DCD     192, 3376
          DCD     200, 3384
          DCD     208, 3392
          DCD     216, 3400
          DCD     224, 3408
          DCD     232, 3416
          DCD     240, 3000
          DCD     248, 0
          DCD     -1, -1
          ; frame 46
          DCD     8, 8
          DCD     16, 680
          DCD     24, 824
          DCD     32, 832
          DCD     40, 832
          DCD     48, 3424
          DCD     56, 3424
          DCD     64, 824
          DCD     72, 824
          DCD     80, 3432
          DCD     88, 3440
          DCD     96, 3448
          DCD     104, 3312
          DCD     112, 784
          DCD     120, 72
          DCD     136, 776
          DCD     144, 768
          DCD     152, 760
          DCD     160, 752
          DCD     168, 744
          DCD     176, 736
          DCD     184, 3456
          DCD     192, 3464
          DCD     200, 3472
          DCD     208, 3480
          DCD     216, 3488
          DCD     224, 3496
          DCD     232, 552
          DCD     240, 8
          DCD     -1, -1
          ; frame 47
          DCD     16, 16
          DCD     24, 40
          DCD     32, 32
          DCD     40, 32
          DCD     48, 32
          DCD     56, 32
          DCD     64, 32
          DCD     72, 40
          DCD     80, 16
          DCD     88, 3504
          DCD     96, 88
          DCD     104, 80
          DCD     112, 72
          DCD     136, 72
          DCD     144, 80
          DCD     152, 88
          DCD     160, 96
          DCD     168, 104
          DCD     176, 112
          DCD     184, 3512
          DCD     192, 3520
          DCD     200, 3528
          DCD     208, 3536
          DCD     216, 3544
          DCD     224, 160
          DCD     232, 168
          DCD     -1, -1
          ; frame 48
          DCD     64, 40
          DCD     88, 3552
          DCD     96, 3560
          DCD     184, 120
          DCD     192, 128
          DCD     200, 136
          DCD     208, 144
          DCD     216, 152
          DCD     -1, -1

; Offsets into the deltas for each frame
frame_deltas
          DCD     0  ; frame 0
          DCD     264  ; frame 1
          DCD     272  ; frame 2
          DCD     328  ; frame 3
          DCD     336  ; frame 4
          DCD     392  ; frame 5
          DCD     400  ; frame 6
          DCD     496  ; frame 7
          DCD     504  ; frame 8
          DCD     536  ; frame 9
          DCD     544  ; frame 10
          DCD     592  ; frame 11
          DCD     600  ; frame 12
          DCD     656  ; frame 13
          DCD     664  ; frame 14
          DCD     728  ; frame 15
          DCD     736  ; frame 16
          DCD     816  ; frame 17
          DCD     824  ; frame 18
          DCD     888  ; frame 19
          DCD     896  ; frame 20
          DCD     992  ; frame 21
          DCD     1000  ; frame 22
          DCD     1008  ; frame 23
          DCD     1016  ; frame 24
          DCD     1024  ; frame 25
          DCD     1032  ; frame 26
          DCD     1040  ; frame 27
          DCD     1048  ; frame 28
          DCD     1056  ; frame 29
          DCD     1064  ; frame 30
          DCD     1232  ; frame 31
          DCD     1432  ; frame 32
          DCD     1696  ; frame 33
          DCD     1952  ; frame 34
          DCD     2184  ; frame 35
          DCD     2440  ; frame 36
          DCD     2704  ; frame 37
          DCD     2968  ; frame 38
          DCD     3232  ; frame 39
          DCD     3464  ; frame 40
          DCD     3664  ; frame 41
          DCD     3912  ; frame 42
          DCD     4176  ; frame 43
          DCD     4440  ; frame 44
          DCD     4704  ; frame 45
          DCD     4960  ; frame 46
          DCD     5200  ; frame 47
          DCD     5416  ; frame 48

; Palette data
palette
          DCB     24, 154, 248
          DCB     0, 0, 0
          ALIGN

; Read the period between frames
; <=  R0 = cs between frames
hourglass_getframeperiod SIGNATURE
          EXPORT  hourglass_getframeperiod
          MOV     r0, #period
          MOV     pc, lr


; Read the size of the workspace block
; <=  R0 = size of hourglass workspace
hourglass_getwssize SIGNATURE
          EXPORT  hourglass_getwssize
          MOV     r0, #hg_workspacesize
          MOV     pc, lr

; Initialisation function
; =>  R0 = hourglass workspace
hourglass_init SIGNATURE
          EXPORT  hourglass_init
          MOV     r12, r0
          MOV     r0, #0
          STR     r0, hg_framenum
          STR     r0, hg_percentage
          STR     r0, hg_leds
          LDR     r0, wordblock_0
          STR     r0, hg_word
          LDR     r0, wordblock_4
          ADR     r1, hg_currentdata
          ORR     r0, r0, r1, LSL #16         ; assign the low half word of pointer data
          STR     r0, hg_word + 4
          MOV     r0, r1, LSR #16             ; and the high half word
          STR     r0, hg_word + 8
; no need to initialise the currentdata; it will be updated by the first frame
          MOV     pc, lr

wordblock_0
          DCB     0                           ; define pointer shape
          DCB     2                           ; shape number (will toggle 2-3)
          DCB     (width*2+7)/8               ; width in bytes
          DCB     height                      ; height
wordblock_4
          DCB     active_x                    ; active x offset
          DCB     active_y                    ; active y offset
          DCB     0                           ; b0-7 of the address of the pointer data
          DCB     0                           ; b8-15 of address of the pointer data

; Start the hourglass
; =>  R0 = hourglass workspace
hourglass_start SIGNATURE
          EXPORT  hourglass_start
          STMFD   sp!, {r4, r5, lr}
          SUB     sp, sp, #8
          MOV     r12, r0
          MOV     r0, #0
          STR     r0, hg_framenum
          MOV     r0, #1
          MOV     r1, #25                     ; read pointer colour 1
          SWI     XOS_ReadPalette
          LDRVS   r2, =&81397900              ; purple if it wasn't set
          STR     r2, hg_oldcolours + 4 * 0
          MOV     r0, #2
          MOV     r1, #25                     ; read pointer colour 2
          SWI     XOS_ReadPalette
          LDRVS   r2, =&66FFFF00              ; yellow if it wasn't set
          STR     r2, hg_oldcolours + 4 * 1
          MOV     r0, #3
          MOV     r1, #25                     ; read pointer colour 3
          SWI     XOS_ReadPalette
          LDRVS   r2, =&00000000              ; black if it wasn't set
          STR     r2, hg_oldcolours + 4 * 2
; now set the palette up for our hourglass
          MOV     r1, sp
          ADRL    r2, palette
; colour 1
          MOV     r0, #1
          STRB    r0, [r1, #0]
          MOV     r0, #25                     ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                ; blue
          MOV     r0, #12
          SWI     XOS_Word                    ; Set palette
; colour 2
          MOV     r0, #2
          STRB    r0, [r1, #0]
          MOV     r0, #25                     ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                ; blue
          MOV     r0, #12
          SWI     XOS_Word                    ; Set palette
          MOV     r1, #127                        ; invalid pointer number to read the pointer
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte
          MOVVS   r1, #0                          ; if there was an error, turn off
          STR     r1, hg_oldpointer
          ADD     sp, sp, #8
          LDMFD   sp!, {r4, r5, lr}
          MOV     r0, r12
          B       hourglass_frame                 ; exit via the first frame

; Stop the hourglass
; =>  R0 = hourglass workspace
hourglass_stop SIGNATURE
          EXPORT  hourglass_stop
          STMFD   sp!, {r4, r5, lr}
          SUB     sp, sp, #8
          MOV     r12, r0
; restore the palette up for old pointer
          MOV     r1, sp
; colour 1
          ADR     r2, hg_oldcolours + 4 * 0 + 1
          MOV     r0, #1
          STRB    r0, [r1, #0]
          MOV     r0, #25                         ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                    ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                    ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                    ; blue
          MOV     r0, #12
          SWI     XOS_Word                        ; Set palette
; colour 2
          ADR     r2, hg_oldcolours + 4 * 1 + 1
          MOV     r0, #2
          STRB    r0, [r1, #0]
          MOV     r0, #25                         ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                    ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                    ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                    ; blue
          MOV     r0, #12
          SWI     XOS_Word                        ; Set palette
          LDR     r1, hg_oldpointer               ; re-select the old pointer number
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte
          ADD     sp, sp, #8
          LDMFD   sp!, {r4, r5, pc}

; Frame update - sets the hourglass shape for the current frame
; =>  R0 = hourglass workspace
hourglass_frame SIGNATURE
          EXPORT  hourglass_frame
          STMFD   sp!, {r4, r5, lr}
          MOV     r12, r0
          LDR     r0, hg_framenum
          ADRL    r1, frame_deltas
          LDR     r0, [r1, r0, LSL #2]            ; offset within deltas for this frame
          ADRL    r1, deltas
          ADD     r1, r1, r0
          ADRL    r2, rowdata
          ADRL    r5, hg_currentdata
rowloop
          LDMIA   r1!, {r3, r4}                   ; r3 = currentdata offset, row data offset
          CMP     r3, #-1                         ; end of the rows
          BEQ     rowend
          LDR     r0, [r4, r2]!                   ; read a word from rowdata
          STR     r0, [r3, r5]!                   ; store into the currentdata
      [ wordsperrow > 1
          LDR     r0, [r4, #4]!                   ; read a word from rowdata
          STR     r0, [r3, #4]!                   ; store into the currentdata
      ]
      [ wordsperrow > 2
          LDR     r0, [r4, #4]!                   ; read a word from rowdata
          STR     r0, [r3, #4]!                   ; store into the currentdata
      ]
      [ wordsperrow > 3
          LDR     r0, [r4, #4]!                   ; read a word from rowdata
          STR     r0, [r3, #4]!                   ; store into the currentdata
      ]
          B       rowloop

rowend
          MOV     r0, #21                         ; Set Pointer parameters
          ADR     r1, hg_word
          SWI     XOS_Word

          LDRB    r1, hg_word + 1                 ; get the hourglass pointer number we will use
          EOR     lr, r1, #1
          STRB    lr, hg_word + 1                 ; toggles the pointer number we use next time
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte

          LDR     r0, hg_framenum
          ADD     r0, r0, #1
          TEQ     r0, #nframes
          MOVEQ   r0, #0                          ; reset counter; we've cycled
          STR     r0, hg_framenum
          LDMFD   sp!, {r4, r5, pc}

; Frame update within an IRQ
; =>  R12 = hourglass workspace
hourglass_frame_irq SIGNATURE
          EXPORT  hourglass_frame_irq
          STMFD   sp!, {r0-r3, r4, r5, r12, lr}
          MOV     r0, r12
          MRS     r4, CPSR
          AND     r1, r4, #&F
          ORR     r1, r1, #&3
          MSR     CPSR_csxf, r1                    ; Enter SVC mode (keep bitness)
          MOV     r5, lr
          BL      hourglass_frame
          MOV     lr, r5
          MSR     CPSR_cxsf, r4                    ; Restore the mode
          LDMFD   sp!, {r0-r3, r4, r5, r12, pc}

          END
