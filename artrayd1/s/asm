          AREA |C$$code|, CODE, READONLY

; constants
width             * 32
height            * 32
period            * 3
wordsperrow       * 2
nwords            * 778
nframes           * 49
active_x          * 16
active_y          * 16

; Workspace for changing the hourglass rendition
                  ^ 0, r12
hg_framenum       # 4                         ; frame number
hg_percentage     # 4                         ; percentage to show (N/I)
hg_leds           # 4                         ; LED flags (N/I)
hg_oldpointer     # 4                         ; Old pointer configuration
hg_oldcolours     # 4 * 3                     ; Old palette entries
hg_word           # 12                        ; OS_Word block
hg_currentdata    # 4 * wordsperrow * height  ; Current data for the hourglass
hg_workspacesize  * :INDEX: @                 ; Size of this workspace

; SWI numbers
XOS_Byte          * 0x20006
XOS_Word          * 0x20007
XOS_ReadPalette   * 0x2002F

; -------------------------------------------------
        MACRO
$label  SIGNATURE
        ALIGN   4
        =       "$label",0
        ALIGN   4
        DCD     &FF000000+(:LEN:"$label"+4):AND::NOT:3
$label
        MEND

; Data for the rows of the hourglass
rowdata
          DCD     &00000000, &00000000
          DCD     &55400000, &00000155
          DCD     &55540000, &00001555
          DCD     &00550000, &00005500
          DCD     &55550000, &00015555
          DCD     &55550000, &00005555
          DCD     &55500000, &00000555
          DCD     &05000000, &00000050
          DCD     &14000000, &00000014
          DCD     &01400000, &00000140
          DCD     &00500000, &00000500
          DCD     &00140000, &00001400
          DCD     &00050000, &00005000
          DCD     &00010000, &00004000
          DCD     &00010000, &00014000
          DCD     &55410000, &00014155
          DCD     &01550000, &00015550
          DCD     &00050000, &00015400
          DCD     &00150000, &00005400
          DCD     &15540000, &00001554
          DCD     &50050000, &00015455
          DCD     &55000000, &00000055
          DCD     &54000000, &00000015
          DCD     &00050000, &00015000
          DCD     &45000000, &00000050
          DCD     &41400000, &00000140
          DCD     &40500000, &00000500
          DCD     &00150000, &00015400
          DCD     &05000000, &00000051
          DCD     &01400000, &00000141
          DCD     &00500000, &00000501
          DCD     &00140000, &00001401
          DCD     &00050000, &00005001
          DCD     &00010000, &00004001
          DCD     &40010000, &00014001
          DCD     &41550000, &00015551
          DCD     &40050000, &00015401
          DCD     &50150000, &00005405
          DCD     &55050000, &00014055
          DCD     &01550000, &00005400
          DCD     &55050000, &00015455
          DCD     &55010000, &00014055
          DCD     &00050000, &00004000
          DCD     &50010000, &00014005
          DCD     &00150000, &00005000
          DCD     &01540000, &00001500
          DCD     &40050000, &00005001
          DCD     &55010000, &00004055
          DCD     &55510000, &00014155
          DCD     &55550000, &00014555
          DCD     &00540000, &00001400
          DCD     &05500000, &00000540
          DCD     &40140000, &00001401
          DCD     &55550000, &00005155
          DCD     &01500000, &00000500
          DCD     &15400000, &00000150
          DCD     &40500000, &00000501
          DCD     &00154000, &00005400
          DCD     &00014000, &00005400
          DCD     &00154000, &00005500
          DCD     &55554000, &00005155
          DCD     &55414000, &00005015
          DCD     &00014000, &00005000
          DCD     &00050000, &00001400
          DCD     &00050000, &00001500
          DCD     &00540000, &00000500
          DCD     &01500000, &00000140
          DCD     &01400000, &00000540
          DCD     &01500000, &00001500
          DCD     &55540000, &00005555
          DCD     &00154000, &00001400
          DCD     &00015000, &00001500
          DCD     &00015000, &00001540
          DCD     &50555000, &00001055
          DCD     &55555000, &00001005
          DCD     &00005000, &00001400
          DCD     &00014000, &00001400
          DCD     &00054000, &00000500
          DCD     &00150000, &00000140
          DCD     &00500000, &00000050
          DCD     &01400000, &00000050
          DCD     &05000000, &00000014
          DCD     &14000000, &00000054
          DCD     &14000000, &00000140
          DCD     &05000000, &00001500
          DCD     &05400000, &00005400
          DCD     &55500000, &00015555
          DCD     &55540000, &00015555
          DCD     &55540000, &00055555
          DCD     &55400000, &00000055
          DCD     &55540000, &00000155
          DCD     &00154000, &00000150
          DCD     &00015000, &00000150
          DCD     &00005400, &00000515
          DCD     &50001500, &00000501
          DCD     &55555500, &00000500
          DCD     &01555400, &00000140
          DCD     &00001400, &00000140
          DCD     &00001400, &00000050
          DCD     &00005000, &00000050
          DCD     &00054000, &00000014
          DCD     &00550000, &00000014
          DCD     &05500000, &00000004
          DCD     &15000000, &00000014
          DCD     &10000000, &00000150
          DCD     &14000000, &00001500
          DCD     &14000000, &00015000
          DCD     &55000000, &00055001
          DCD     &55000000, &00155555
          DCD     &55400000, &00155555
          DCD     &55400000, &00555555
          DCD     &55500000, &00555555
          DCD     &55500000, &00155555
          DCD     &55400000, &00055555
          DCD     &55400000, &00015555
          DCD     &55400000, &00001555
          DCD     &55000000, &00000155
          DCD     &55540000, &00001550
          DCD     &00005000, &00001550
          DCD     &55555000, &00001401
          DCD     &00014000, &00000500
          DCD     &00540000, &00000050
          DCD     &01400000, &00000014
          DCD     &14000000, &00000050
          DCD     &05400000, &00005500
          DCD     &55500000, &00001555
          DCD     &00150000, &00014000
          DCD     &01550000, &00015000
          DCD     &55450000, &00015555
          DCD     &54050000, &00014155
          DCD     &00050000, &00014000
          DCD     &00140000, &00005000
          DCD     &00540000, &00005400
          DCD     &05400000, &00000050
          DCD     &00540000, &00000550
          DCD     &55550000, &00001555
          DCD     &55554000, &00005555
          DCD     &15400000, &00001554
          DCD     &01400000, &00015400
          DCD     &05500000, &00054000
          DCD     &54500000, &00150000
          DCD     &50500000, &00140005
          DCD     &00500000, &00155555
          DCD     &00500000, &00155540
          DCD     &01400000, &00140000
          DCD     &01400000, &00050000
          DCD     &05000000, &00054000
          DCD     &14000000, &00005400
          DCD     &05400000, &00000014
          DCD     &00540000, &00000014
          DCD     &00154000, &00000010
          DCD     &00555000, &00000054
          DCD     &55555000, &00000155
          DCD     &55555400, &00000155
          DCD     &55555400, &00000555
          DCD     &55555000, &00000555
          DCD     &55554000, &00000155
          DCD     &50000000, &00000155
          DCD     &50000000, &00001555
          DCD     &54000000, &00015401
          DCD     &54000000, &00054001
          DCD     &05000000, &00150005
          DCD     &05000000, &00500014
          DCD     &05000000, &01500150
          DCD     &04000000, &01401540
          DCD     &14000000, &01555400
          DCD     &14000000, &01554000
          DCD     &10000000, &00500000
          DCD     &50000000, &00500000
          DCD     &50000000, &00154000
          DCD     &50000000, &00055500
          DCD     &14000000, &00000554
          DCD     &05540000, &00000014
          DCD     &00555000, &00000005
          DCD     &00005400, &00000005
          DCD     &00015500, &00000004
          DCD     &55555500, &00000005
          DCD     &55555540, &00000015
          DCD     &55555540, &00000055
          DCD     &55555500, &00000055
          DCD     &55555400, &00000055
          DCD     &55555000, &00000015
          DCD     &55554000, &00000015
          DCD     &55540000, &00000005
          DCD     &55400000, &00000001
          DCD     &00000000, &00000140
          DCD     &00000000, &00001550
          DCD     &00000000, &00015554
          DCD     &00000000, &00054055
          DCD     &40000000, &00140141
          DCD     &40000000, &00500141
          DCD     &40000000, &01500501
          DCD     &40000000, &01400500
          DCD     &40000000, &05001400
          DCD     &40000000, &05005000
          DCD     &40000000, &14054000
          DCD     &40000000, &15540000
          DCD     &40000000, &15500000
          DCD     &54000000, &05400000
          DCD     &15555500, &01540000
          DCD     &00015540, &00155554
          DCD     &00055550, &00000005
          DCD     &05555554, &00000001
          DCD     &55555554, &00000001
          DCD     &55555550, &00000001
          DCD     &55555540, &00000001
          DCD     &55555500, &00000001
          DCD     &55555400, &00000001
          DCD     &55555000, &00000000
          DCD     &15554000, &00000000
          DCD     &05540000, &00000000
          DCD     &01000000, &00000000
          DCD     &00000000, &00015000
          DCD     &00000000, &00055500
          DCD     &00000000, &00155550
          DCD     &00000000, &00505050
          DCD     &00000000, &01405014
          DCD     &00000000, &05005004
          DCD     &00000000, &05004004
          DCD     &00000000, &14014005
          DCD     &00055500, &14014001
          DCD     &40555550, &14050001
          DCD     &55505554, &14040000
          DCD     &00055554, &14140000
          DCD     &00555554, &15500014
          DCD     &45555554, &15400555
          DCD     &55555554, &05555501
          DCD     &55555554, &00554000
          DCD     &55555554, &00000000
          DCD     &15555550, &00000000
          DCD     &15555540, &00000000
          DCD     &05555540, &00000000
          DCD     &05555500, &00000000
          DCD     &01555400, &00000000
          DCD     &00555000, &00000000
          DCD     &00054000, &00000000
          DCD     &00000000, &00555000
          DCD     &00000000, &01555400
          DCD     &00000000, &01540500
          DCD     &00015540, &05040140
          DCD     &00155550, &05050140
          DCD     &00555554, &14050050
          DCD     &01415554, &14050014
          DCD     &55055554, &14050005
          DCD     &54055554, &14050001
          DCD     &00155554, &14050000
          DCD     &00555554, &14040000
          DCD     &41555554, &14040015
          DCD     &55555554, &14140055
          DCD     &15555554, &14100140
          DCD     &05555554, &15501500
          DCD     &01555550, &05515400
          DCD     &01555550, &01554000
          DCD     &00555540, &00000000
          DCD     &00155540, &00000000
          DCD     &00055500, &00000000
          DCD     &00001400, &00000000
          DCD     &00155500, &00000000
          DCD     &01555540, &00000000
          DCD     &01555550, &00150000
          DCD     &05155550, &05555000
          DCD     &04155554, &05405400
          DCD     &14155554, &15400540
          DCD     &50155554, &14500155
          DCD     &40155554, &14140015
          DCD     &00555554, &14140000
          DCD     &55555554, &14050001
          DCD     &55555554, &14050005
          DCD     &01555554, &14050014
          DCD     &00155554, &14010010
          DCD     &00055550, &05010050
          DCD     &00005400, &05010140
          DCD     &00000000, &01450540
          DCD     &00000000, &01555500
          DCD     &00000000, &00555400
          DCD     &00000000, &00150000
          DCD     &00140000, &00000000
          DCD     &01554000, &00000000
          DCD     &05555000, &00000000
          DCD     &15555400, &00000000
          DCD     &15555500, &00000000
          DCD     &51555540, &00000000
          DCD     &51555550, &00000000
          DCD     &41555554, &00000000
          DCD     &41555554, &00000001
          DCD     &45555554, &00555401
          DCD     &05555554, &01555555
          DCD     &05555554, &15000054
          DCD     &15555550, &15000000
          DCD     &55555540, &15500000
          DCD     &40055400, &14540001
          DCD     &40000000, &14050001
          DCD     &00000000, &14014001
          DCD     &00000000, &05014005
          DCD     &00000000, &05005005
          DCD     &00000000, &01401005
          DCD     &00000000, &01501405
          DCD     &00000000, &00500414
          DCD     &00000000, &00150554
          DCD     &00000000, &00055550
          DCD     &00000000, &00015500
          DCD     &00000000, &00000400
          DCD     &55540000, &00000001
          DCD     &55554000, &00000005
          DCD     &55555400, &00000015
          DCD     &55555500, &00000014
          DCD     &15555540, &00000014
          DCD     &05555540, &00000014
          DCD     &05555550, &00000014
          DCD     &01555550, &00000004
          DCD     &01555540, &00000005
          DCD     &05555500, &00000005
          DCD     &05555400, &00000005
          DCD     &05554000, &00000014
          DCD     &15000000, &00015550
          DCD     &50000000, &00155400
          DCD     &50000000, &00540000
          DCD     &10000000, &01400000
          DCD     &10000000, &05550000
          DCD     &14000000, &05555000
          DCD     &14000000, &01405500
          DCD     &14000000, &01400540
          DCD     &14000000, &00500050
          DCD     &14000000, &00140014
          DCD     &14000000, &00054005
          DCD     &50000000, &00015401
          DCD     &40000000, &00001555
          DCD     &40000000, &00000155
          DCD     &55540000, &00000555
          DCD     &55554000, &00001555
          DCD     &55555000, &00001555
          DCD     &55555000, &00001400
          DCD     &55555000, &00000500
          DCD     &55554000, &00000500
          DCD     &15550000, &00000140
          DCD     &15540000, &00000050
          DCD     &15500000, &00000014
          DCD     &01400000, &00005400
          DCD     &00500000, &00014000
          DCD     &00500000, &00050000
          DCD     &00140000, &00050000
          DCD     &50140000, &00055555
          DCD     &55140000, &00054000
          DCD     &01540000, &00054000
          DCD     &00540000, &00015400
          DCD     &15500000, &00001555
          DCD     &55000000, &00055555
          DCD     &54000000, &00015400
          DCD     &54000000, &00005500
          DCD     &05400000, &00000004
          DCD     &05555500, &00000500
          DCD     &55001500, &00000500
          DCD     &40005400, &00000505
          DCD     &00015000, &00000155
          DCD     &15540000, &00000154
          DCD     &55500000, &00055555
          DCD     &55540000, &00155555
          DCD     &55000000, &00015555
          DCD     &15000000, &00005500
          DCD     &14000000, &00000540
          DCD     &14000000, &00000150
          DCD     &01500000, &00000014
          DCD     &00150000, &00000050
          DCD     &00054000, &00000050
          DCD     &00015000, &00000140
          DCD     &00005000, &00000500
          DCD     &00001000, &00000500
          DCD     &15555400, &00001400
          DCD     &55555400, &00001405
          DCD     &40005400, &00001415
          DCD     &00015000, &00000550
          DCD     &00154000, &00000540
          DCD     &55540000, &00000554
          DCD     &55550000, &00055555
          DCD     &55500000, &00005555
          DCD     &55400000, &00001550
          DCD     &05000000, &00000540
          DCD     &00004000, &00001400
          DCD     &00005000, &00005000
          DCD     &55555000, &00005015
          DCD     &00015000, &00001554
          DCD     &00154000, &00001500
          DCD     &00500000, &00000550
          DCD     &00014000, &00004000
          DCD     &55414000, &00004155
          DCD     &01554000, &00005550
          DCD     &00054000, &00005400
          DCD     &51500000, &00000555
          DCD     &01400000, &00000150

; Data for deltas between frames
deltas
          ; frame 0
          DCD     0, 0
          DCD     8, 8
          DCD     16, 16
          DCD     24, 24
          DCD     32, 32
          DCD     40, 32
          DCD     48, 32
          DCD     56, 32
          DCD     64, 40
          DCD     72, 40
          DCD     80, 16
          DCD     88, 48
          DCD     96, 8
          DCD     104, 56
          DCD     112, 64
          DCD     120, 64
          DCD     128, 64
          DCD     136, 64
          DCD     144, 56
          DCD     152, 72
          DCD     160, 80
          DCD     168, 88
          DCD     176, 96
          DCD     184, 104
          DCD     192, 112
          DCD     200, 120
          DCD     208, 128
          DCD     216, 136
          DCD     224, 144
          DCD     232, 152
          DCD     240, 8
          DCD     248, 0
          DCD     -1, -1
          ; frame 1
          DCD     -1, -1
          ; frame 2
          DCD     24, 144
          DCD     32, 160
          DCD     104, 168
          DCD     112, 176
          DCD     120, 176
          DCD     128, 176
          DCD     -1, -1
          ; frame 3
          DCD     -1, -1
          ; frame 4
          DCD     32, 184
          DCD     136, 176
          DCD     144, 192
          DCD     152, 200
          DCD     160, 208
          DCD     -1, -1
          ; frame 5
          DCD     -1, -1
          ; frame 6
          DCD     40, 216
          DCD     144, 224
          DCD     152, 232
          DCD     160, 240
          DCD     168, 248
          DCD     176, 256
          DCD     184, 264
          DCD     192, 272
          DCD     208, 280
          DCD     -1, -1
          ; frame 7
          DCD     -1, -1
          ; frame 8
          DCD     216, 288
          DCD     224, 296
          DCD     232, 16
          DCD     -1, -1
          ; frame 9
          DCD     -1, -1
          ; frame 10
          DCD     56, 304
          DCD     64, 312
          DCD     208, 32
          DCD     216, 320
          DCD     224, 40
          DCD     -1, -1
          ; frame 11
          DCD     -1, -1
          ; frame 12
          DCD     56, 328
          DCD     64, 336
          DCD     72, 312
          DCD     192, 344
          DCD     216, 32
          DCD     -1, -1
          ; frame 13
          DCD     -1, -1
          ; frame 14
          DCD     72, 352
          DCD     80, 360
          DCD     176, 368
          DCD     184, 376
          DCD     192, 384
          DCD     200, 392
          DCD     -1, -1
          ; frame 15
          DCD     -1, -1
          ; frame 16
          DCD     64, 104
          DCD     72, 96
          DCD     80, 400
          DCD     88, 408
          DCD     168, 416
          DCD     176, 424
          DCD     184, 40
          DCD     192, 32
          DCD     200, 32
          DCD     -1, -1
          ; frame 17
          DCD     -1, -1
          ; frame 18
          DCD     80, 88
          DCD     88, 432
          DCD     96, 440
          DCD     160, 448
          DCD     168, 16
          DCD     176, 40
          DCD     -1, -1
          ; frame 19
          DCD     -1, -1
          ; frame 20
          DCD     88, 80
          DCD     96, 72
          DCD     104, 56
          DCD     112, 64
          DCD     120, 64
          DCD     128, 64
          DCD     136, 64
          DCD     144, 56
          DCD     152, 72
          DCD     160, 80
          DCD     -1, -1
          ; frame 21
          DCD     -1, -1
          ; frame 22
          DCD     -1, -1
          ; frame 23
          DCD     -1, -1
          ; frame 24
          DCD     -1, -1
          ; frame 25
          DCD     -1, -1
          ; frame 26
          DCD     -1, -1
          ; frame 27
          DCD     -1, -1
          ; frame 28
          DCD     -1, -1
          ; frame 29
          DCD     -1, -1
          ; frame 30
          DCD     24, 456
          DCD     32, 464
          DCD     40, 472
          DCD     48, 480
          DCD     56, 488
          DCD     64, 496
          DCD     72, 504
          DCD     80, 512
          DCD     88, 520
          DCD     96, 528
          DCD     152, 536
          DCD     160, 544
          DCD     168, 552
          DCD     176, 552
          DCD     184, 32
          DCD     224, 32
          DCD     -1, -1
          ; frame 31
          DCD     24, 560
          DCD     32, 568
          DCD     40, 576
          DCD     48, 584
          DCD     56, 592
          DCD     64, 600
          DCD     72, 608
          DCD     80, 616
          DCD     88, 624
          DCD     96, 632
          DCD     104, 640
          DCD     112, 648
          DCD     136, 656
          DCD     144, 664
          DCD     152, 672
          DCD     160, 680
          DCD     168, 688
          DCD     176, 696
          DCD     184, 704
          DCD     192, 704
          DCD     200, 704
          DCD     208, 704
          DCD     216, 704
          DCD     224, 696
          DCD     -1, -1
          ; frame 32
          DCD     8, 712
          DCD     16, 720
          DCD     24, 728
          DCD     32, 736
          DCD     40, 744
          DCD     48, 752
          DCD     56, 760
          DCD     64, 768
          DCD     72, 776
          DCD     80, 784
          DCD     88, 792
          DCD     96, 800
          DCD     104, 808
          DCD     112, 816
          DCD     120, 824
          DCD     128, 656
          DCD     136, 832
          DCD     144, 840
          DCD     152, 848
          DCD     160, 856
          DCD     168, 864
          DCD     176, 872
          DCD     184, 872
          DCD     192, 880
          DCD     200, 888
          DCD     208, 896
          DCD     216, 904
          DCD     224, 912
          DCD     232, 920
          DCD     240, 928
          DCD     -1, -1
          ; frame 33
          DCD     8, 8
          DCD     16, 936
          DCD     24, 560
          DCD     32, 568
          DCD     40, 944
          DCD     48, 584
          DCD     56, 952
          DCD     64, 600
          DCD     72, 960
          DCD     80, 616
          DCD     88, 624
          DCD     96, 968
          DCD     104, 976
          DCD     112, 824
          DCD     120, 64
          DCD     128, 64
          DCD     136, 984
          DCD     144, 664
          DCD     152, 672
          DCD     160, 992
          DCD     168, 688
          DCD     176, 688
          DCD     184, 704
          DCD     192, 704
          DCD     200, 704
          DCD     208, 704
          DCD     216, 704
          DCD     224, 696
          DCD     232, 1000
          DCD     -1, -1
          ; frame 34
          DCD     16, 16
          DCD     24, 216
          DCD     32, 1008
          DCD     40, 1016
          DCD     48, 1024
          DCD     56, 1032
          DCD     64, 1040
          DCD     72, 1048
          DCD     80, 1056
          DCD     88, 544
          DCD     96, 72
          DCD     104, 56
          DCD     112, 64
          DCD     136, 64
          DCD     144, 1064
          DCD     152, 528
          DCD     160, 1072
          DCD     168, 1080
          DCD     176, 1080
          DCD     184, 1088
          DCD     192, 1088
          DCD     200, 1088
          DCD     208, 1088
          DCD     216, 1088
          DCD     224, 1088
          DCD     232, 16
          DCD     240, 712
          DCD     -1, -1
          ; frame 35
          DCD     8, 928
          DCD     16, 1096
          DCD     24, 1104
          DCD     32, 1112
          DCD     40, 1120
          DCD     48, 1128
          DCD     56, 1136
          DCD     64, 1144
          DCD     72, 1152
          DCD     80, 1160
          DCD     88, 1168
          DCD     96, 1176
          DCD     104, 840
          DCD     112, 832
          DCD     128, 824
          DCD     136, 1184
          DCD     144, 1192
          DCD     152, 1200
          DCD     160, 1208
          DCD     168, 1216
          DCD     176, 1224
          DCD     184, 1232
          DCD     192, 1232
          DCD     200, 1232
          DCD     208, 1232
          DCD     216, 1240
          DCD     224, 1248
          DCD     232, 720
          DCD     -1, -1
          ; frame 36
          DCD     8, 1256
          DCD     16, 1264
          DCD     24, 1272
          DCD     32, 1280
          DCD     40, 1288
          DCD     48, 1296
          DCD     56, 1304
          DCD     64, 1312
          DCD     72, 1320
          DCD     80, 1328
          DCD     88, 1336
          DCD     96, 1344
          DCD     104, 1352
          DCD     112, 1360
          DCD     120, 1368
          DCD     128, 1376
          DCD     136, 1384
          DCD     144, 1392
          DCD     152, 1400
          DCD     160, 1408
          DCD     168, 1416
          DCD     176, 1416
          DCD     184, 1416
          DCD     192, 1424
          DCD     200, 1432
          DCD     208, 1440
          DCD     216, 1448
          DCD     224, 1456
          DCD     232, 1464
          DCD     240, 1472
          DCD     -1, -1
          ; frame 37
          DCD     8, 1480
          DCD     16, 1488
          DCD     24, 1496
          DCD     32, 1504
          DCD     40, 1512
          DCD     48, 1520
          DCD     56, 1528
          DCD     64, 1536
          DCD     72, 1544
          DCD     80, 1552
          DCD     88, 1560
          DCD     96, 1568
          DCD     104, 1576
          DCD     112, 1584
          DCD     120, 1592
          DCD     128, 1600
          DCD     136, 1608
          DCD     144, 1616
          DCD     152, 1624
          DCD     160, 1624
          DCD     168, 1632
          DCD     176, 1632
          DCD     184, 1640
          DCD     192, 1640
          DCD     200, 1648
          DCD     208, 1656
          DCD     216, 1664
          DCD     224, 1672
          DCD     232, 1680
          DCD     240, 1688
          DCD     -1, -1
          ; frame 38
          DCD     8, 0
          DCD     16, 0
          DCD     24, 1696
          DCD     32, 1704
          DCD     40, 1712
          DCD     48, 1720
          DCD     56, 1728
          DCD     64, 1728
          DCD     72, 1736
          DCD     80, 1744
          DCD     88, 1752
          DCD     96, 1760
          DCD     104, 1768
          DCD     112, 1776
          DCD     120, 1784
          DCD     128, 1792
          DCD     136, 1800
          DCD     144, 1808
          DCD     152, 1816
          DCD     160, 1824
          DCD     168, 1832
          DCD     176, 1832
          DCD     184, 1840
          DCD     192, 1848
          DCD     200, 1856
          DCD     208, 1864
          DCD     216, 1872
          DCD     224, 1880
          DCD     232, 0
          DCD     240, 0
          DCD     -1, -1
          ; frame 39
          DCD     24, 0
          DCD     32, 0
          DCD     40, 0
          DCD     48, 1888
          DCD     56, 1896
          DCD     64, 1904
          DCD     72, 1912
          DCD     80, 1920
          DCD     88, 1928
          DCD     96, 1936
          DCD     104, 1944
          DCD     112, 1952
          DCD     120, 1960
          DCD     128, 1968
          DCD     136, 1976
          DCD     144, 1984
          DCD     152, 1992
          DCD     160, 2000
          DCD     168, 2008
          DCD     176, 2016
          DCD     184, 2024
          DCD     192, 2032
          DCD     200, 2040
          DCD     208, 0
          DCD     216, 0
          DCD     224, 0
          DCD     -1, -1
          ; frame 40
          DCD     40, 2048
          DCD     48, 2056
          DCD     56, 2024
          DCD     64, 2064
          DCD     72, 2072
          DCD     80, 2080
          DCD     88, 2088
          DCD     96, 2096
          DCD     104, 2104
          DCD     112, 2112
          DCD     120, 2120
          DCD     136, 2128
          DCD     144, 2136
          DCD     152, 2144
          DCD     160, 2152
          DCD     168, 2160
          DCD     176, 2168
          DCD     184, 2176
          DCD     192, 2184
          DCD     200, 2192
          DCD     208, 2200
          DCD     -1, -1
          ; frame 41
          DCD     16, 2208
          DCD     24, 2216
          DCD     32, 2224
          DCD     40, 2232
          DCD     48, 2240
          DCD     56, 1840
          DCD     64, 2248
          DCD     72, 2256
          DCD     80, 2256
          DCD     88, 2264
          DCD     96, 2272
          DCD     104, 2280
          DCD     112, 2288
          DCD     120, 2296
          DCD     128, 2304
          DCD     136, 2312
          DCD     144, 2320
          DCD     152, 2328
          DCD     160, 2336
          DCD     168, 2344
          DCD     176, 2352
          DCD     184, 2360
          DCD     192, 2368
          DCD     200, 2376
          DCD     208, 2384
          DCD     216, 2392
          DCD     224, 2400
          DCD     232, 2408
          DCD     -1, -1
          ; frame 42
          DCD     8, 1472
          DCD     16, 2416
          DCD     24, 2424
          DCD     32, 1448
          DCD     40, 2432
          DCD     48, 2440
          DCD     56, 2448
          DCD     64, 2456
          DCD     72, 2464
          DCD     80, 2472
          DCD     88, 2480
          DCD     96, 2480
          DCD     104, 2488
          DCD     112, 2496
          DCD     120, 2504
          DCD     128, 2512
          DCD     136, 2520
          DCD     144, 2528
          DCD     152, 1344
          DCD     160, 2536
          DCD     168, 2544
          DCD     176, 2552
          DCD     184, 2560
          DCD     192, 2568
          DCD     200, 2576
          DCD     208, 2584
          DCD     216, 2592
          DCD     224, 2600
          DCD     232, 2608
          DCD     240, 2616
          DCD     -1, -1
          ; frame 43
          DCD     8, 8
          DCD     16, 2624
          DCD     24, 2632
          DCD     32, 2640
          DCD     40, 2640
          DCD     48, 2640
          DCD     56, 2640
          DCD     64, 2648
          DCD     72, 2656
          DCD     80, 2664
          DCD     88, 2672
          DCD     96, 2680
          DCD     104, 2688
          DCD     112, 824
          DCD     120, 64
          DCD     128, 64
          DCD     136, 984
          DCD     144, 664
          DCD     152, 672
          DCD     160, 2696
          DCD     168, 2704
          DCD     176, 2712
          DCD     184, 2720
          DCD     192, 2720
          DCD     200, 2728
          DCD     208, 2736
          DCD     216, 2744
          DCD     224, 2752
          DCD     232, 2760
          DCD     240, 8
          DCD     -1, -1
          ; frame 44
          DCD     8, 928
          DCD     16, 920
          DCD     24, 912
          DCD     32, 904
          DCD     40, 896
          DCD     48, 888
          DCD     56, 888
          DCD     64, 872
          DCD     72, 872
          DCD     80, 864
          DCD     88, 2768
          DCD     96, 2776
          DCD     104, 2784
          DCD     112, 832
          DCD     120, 656
          DCD     128, 824
          DCD     136, 2792
          DCD     144, 1192
          DCD     152, 800
          DCD     160, 792
          DCD     168, 784
          DCD     176, 776
          DCD     184, 776
          DCD     192, 2800
          DCD     200, 2808
          DCD     208, 2816
          DCD     216, 2824
          DCD     224, 728
          DCD     232, 2832
          DCD     240, 712
          DCD     -1, -1
          ; frame 45
          DCD     8, 8
          DCD     16, 1000
          DCD     24, 688
          DCD     32, 2840
          DCD     48, 2848
          DCD     56, 2848
          DCD     64, 2840
          DCD     72, 2840
          DCD     80, 904
          DCD     88, 2856
          DCD     96, 2864
          DCD     104, 2872
          DCD     112, 2880
          DCD     120, 64
          DCD     128, 64
          DCD     136, 648
          DCD     144, 2888
          DCD     152, 2896
          DCD     160, 2904
          DCD     168, 2912
          DCD     176, 2920
          DCD     184, 2928
          DCD     192, 2936
          DCD     200, 2944
          DCD     208, 2952
          DCD     216, 2960
          DCD     224, 2968
          DCD     232, 2976
          DCD     240, 8
          DCD     -1, -1
          ; frame 46
          DCD     16, 16
          DCD     24, 696
          DCD     32, 704
          DCD     40, 704
          DCD     48, 2984
          DCD     56, 2984
          DCD     64, 696
          DCD     72, 696
          DCD     80, 2992
          DCD     88, 3000
          DCD     96, 3008
          DCD     104, 2880
          DCD     112, 656
          DCD     144, 640
          DCD     152, 632
          DCD     160, 624
          DCD     168, 616
          DCD     176, 608
          DCD     184, 3016
          DCD     192, 3024
          DCD     200, 3032
          DCD     208, 3040
          DCD     216, 576
          DCD     224, 3048
          DCD     232, 16
          DCD     -1, -1
          ; frame 47
          DCD     24, 40
          DCD     32, 32
          DCD     40, 32
          DCD     48, 32
          DCD     56, 32
          DCD     64, 32
          DCD     72, 40
          DCD     80, 16
          DCD     88, 3056
          DCD     96, 72
          DCD     104, 56
          DCD     112, 64
          DCD     136, 64
          DCD     144, 56
          DCD     152, 72
          DCD     160, 80
          DCD     168, 88
          DCD     176, 96
          DCD     184, 496
          DCD     192, 3064
          DCD     200, 3072
          DCD     208, 3080
          DCD     216, 3088
          DCD     224, 144
          DCD     232, 152
          DCD     -1, -1
          ; frame 48
          DCD     64, 40
          DCD     88, 3096
          DCD     96, 3104
          DCD     184, 104
          DCD     192, 112
          DCD     200, 120
          DCD     208, 128
          DCD     216, 136
          DCD     -1, -1

; Offsets into the deltas for each frame
frame_deltas
          DCD     0  ; frame 0
          DCD     264  ; frame 1
          DCD     272  ; frame 2
          DCD     328  ; frame 3
          DCD     336  ; frame 4
          DCD     384  ; frame 5
          DCD     392  ; frame 6
          DCD     472  ; frame 7
          DCD     480  ; frame 8
          DCD     512  ; frame 9
          DCD     520  ; frame 10
          DCD     568  ; frame 11
          DCD     576  ; frame 12
          DCD     624  ; frame 13
          DCD     632  ; frame 14
          DCD     688  ; frame 15
          DCD     696  ; frame 16
          DCD     776  ; frame 17
          DCD     784  ; frame 18
          DCD     840  ; frame 19
          DCD     848  ; frame 20
          DCD     936  ; frame 21
          DCD     944  ; frame 22
          DCD     952  ; frame 23
          DCD     960  ; frame 24
          DCD     968  ; frame 25
          DCD     976  ; frame 26
          DCD     984  ; frame 27
          DCD     992  ; frame 28
          DCD     1000  ; frame 29
          DCD     1008  ; frame 30
          DCD     1144  ; frame 31
          DCD     1344  ; frame 32
          DCD     1592  ; frame 33
          DCD     1832  ; frame 34
          DCD     2056  ; frame 35
          DCD     2288  ; frame 36
          DCD     2536  ; frame 37
          DCD     2784  ; frame 38
          DCD     3032  ; frame 39
          DCD     3248  ; frame 40
          DCD     3424  ; frame 41
          DCD     3656  ; frame 42
          DCD     3904  ; frame 43
          DCD     4152  ; frame 44
          DCD     4400  ; frame 45
          DCD     4640  ; frame 46
          DCD     4848  ; frame 47
          DCD     5056  ; frame 48

; Palette data
palette
          DCB     24, 154, 248
          ALIGN

; Read the period between frames
; <=  R0 = cs between frames
hourglass_getframeperiod SIGNATURE
          EXPORT  hourglass_getframeperiod
          MOV     r0, #period
          MOV     pc, lr


; Read the size of the workspace block
; <=  R0 = size of hourglass workspace
hourglass_getwssize SIGNATURE
          EXPORT  hourglass_getwssize
          MOV     r0, #hg_workspacesize
          MOV     pc, lr

; Initialisation function
; =>  R0 = hourglass workspace
hourglass_init SIGNATURE
          EXPORT  hourglass_init
          MOV     r12, r0
          MOV     r0, #0
          STR     r0, hg_framenum
          STR     r0, hg_percentage
          STR     r0, hg_leds
          LDR     r0, wordblock_0
          STR     r0, hg_word
          LDR     r0, wordblock_4
          ADR     r1, hg_currentdata
          ORR     r0, r0, r1, LSL #16         ; assign the low half word of pointer data
          STR     r0, hg_word + 4
          MOV     r0, r1, LSR #16             ; and the high half word
          STR     r0, hg_word + 8
; no need to initialise the currentdata; it will be updated by the first frame
          MOV     pc, lr

wordblock_0
          DCB     0                           ; define pointer shape
          DCB     2                           ; shape number (will toggle 2-3)
          DCB     (width*2+7)/8               ; width in bytes
          DCB     height                      ; height
wordblock_4
          DCB     active_x                    ; active x offset
          DCB     active_y                    ; active y offset
          DCB     0                           ; b0-7 of the address of the pointer data
          DCB     0                           ; b8-15 of address of the pointer data

; Start the hourglass
; =>  R0 = hourglass workspace
hourglass_start SIGNATURE
          EXPORT  hourglass_start
          STMFD   sp!, {r4, r5, lr}
          SUB     sp, sp, #8
          MOV     r12, r0
          MOV     r0, #0
          STR     r0, hg_framenum
          MOV     r0, #1
          MOV     r1, #25                     ; read pointer colour 1
          SWI     XOS_ReadPalette
          LDRVS   r2, =&81397900              ; purple if it wasn't set
          STR     r2, hg_oldcolours + 4 * 0
          MOV     r0, #2
          MOV     r1, #25                     ; read pointer colour 2
          SWI     XOS_ReadPalette
          LDRVS   r2, =&66FFFF00              ; yellow if it wasn't set
          STR     r2, hg_oldcolours + 4 * 1
          MOV     r0, #3
          MOV     r1, #25                     ; read pointer colour 3
          SWI     XOS_ReadPalette
          LDRVS   r2, =&00000000              ; black if it wasn't set
          STR     r2, hg_oldcolours + 4 * 2
; now set the palette up for our hourglass
          MOV     r1, sp
          ADRL    r2, palette
; colour 1
          MOV     r0, #1
          STRB    r0, [r1, #0]
          MOV     r0, #25                     ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                ; blue
          MOV     r0, #12
          SWI     XOS_Word                    ; Set palette
          MOV     r1, #127                        ; invalid pointer number to read the pointer
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte
          MOVVS   r1, #0                          ; if there was an error, turn off
          STR     r1, hg_oldpointer
          ADD     sp, sp, #8
          LDMFD   sp!, {r4, r5, lr}
          MOV     r0, r12
          B       hourglass_frame                 ; exit via the first frame

; Stop the hourglass
; =>  R0 = hourglass workspace
hourglass_stop SIGNATURE
          EXPORT  hourglass_stop
          STMFD   sp!, {r4, r5, lr}
          SUB     sp, sp, #8
          MOV     r12, r0
; restore the palette up for old pointer
          MOV     r1, sp
; colour 1
          ADR     r2, hg_oldcolours + 4 * 0 + 1
          MOV     r0, #1
          STRB    r0, [r1, #0]
          MOV     r0, #25                         ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                    ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                    ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                    ; blue
          MOV     r0, #12
          SWI     XOS_Word                        ; Set palette
          LDR     r1, hg_oldpointer               ; re-select the old pointer number
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte
          ADD     sp, sp, #8
          LDMFD   sp!, {r4, r5, pc}

; Frame update - sets the hourglass shape for the current frame
; =>  R0 = hourglass workspace
hourglass_frame SIGNATURE
          EXPORT  hourglass_frame
          STMFD   sp!, {r4, r5, lr}
          MOV     r12, r0
          LDR     r0, hg_framenum
          ADRL    r1, frame_deltas
          LDR     r0, [r1, r0, LSL #2]            ; offset within deltas for this frame
          ADRL    r1, deltas
          ADD     r1, r1, r0
          ADRL    r2, rowdata
          ADRL    r5, hg_currentdata
rowloop
          LDMIA   r1!, {r3, r4}                   ; r3 = currentdata offset, row data offset
          CMP     r3, #-1                         ; end of the rows
          BEQ     rowend
          LDR     r0, [r4, r2]!                   ; read a word from rowdata
          STR     r0, [r3, r5]!                   ; store into the currentdata
      [ wordsperrow > 1
          LDR     r0, [r4, #4]!                   ; read a word from rowdata
          STR     r0, [r3, #4]!                   ; store into the currentdata
      ]
      [ wordsperrow > 2
          LDR     r0, [r4, #4]!                   ; read a word from rowdata
          STR     r0, [r3, #4]!                   ; store into the currentdata
      ]
      [ wordsperrow > 3
          LDR     r0, [r4, #4]!                   ; read a word from rowdata
          STR     r0, [r3, #4]!                   ; store into the currentdata
      ]
          B       rowloop

rowend
          MOV     r0, #21                         ; Set Pointer parameters
          ADR     r1, hg_word
          SWI     XOS_Word

          LDRB    r1, hg_word + 1                 ; get the hourglass pointer number we will use
          EOR     lr, r1, #1
          STRB    lr, hg_word + 1                 ; toggles the pointer number we use next time
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte

          LDR     r0, hg_framenum
          ADD     r0, r0, #1
          TEQ     r0, #nframes
          MOVEQ   r0, #0                          ; reset counter; we've cycled
          STR     r0, hg_framenum
          LDMFD   sp!, {r4, r5, pc}

; Frame update within an IRQ
; =>  R12 = hourglass workspace
hourglass_frame_irq SIGNATURE
          EXPORT  hourglass_frame_irq
          STMFD   sp!, {r0-r3, r4, r5, r12, lr}
          MOV     r0, r12
          MRS     r4, CPSR
          AND     r1, r4, #&F
          ORR     r1, r1, #&3
          MSR     CPSR_csxf, r1                    ; Enter SVC mode (keep bitness)
          MOV     r5, lr
          BL      hourglass_frame
          MOV     lr, r5
          MSR     CPSR_cxsf, r4                    ; Restore the mode
          LDMFD   sp!, {r0-r3, r4, r5, r12, pc}

          END
