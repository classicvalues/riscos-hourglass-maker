          AREA |C$$code|, CODE, READONLY

; constants
width             * 32
height            * 32
period            * 3
wordsperrow       * 2
nwords            * 784
nframes           * 49
active_x          * 16
active_y          * 16

; Workspace for changing the hourglass rendition
                  ^ 0, r12
hg_framenum       # 4                         ; frame number
hg_percentage     # 4                         ; percentage to show (N/I)
hg_leds           # 4                         ; LED flags (N/I)
hg_oldpointer     # 4                         ; Old pointer configuration
hg_oldcolours     # 4 * 3                     ; Old palette entries
hg_word           # 12                        ; OS_Word block
hg_currentdata    # 4 * wordsperrow * height  ; Current data for the hourglass
hg_workspacesize  * :INDEX: @                 ; Size of this workspace

; SWI numbers
XOS_Byte          * 0x20006
XOS_Word          * 0x20007
XOS_ReadPalette   * 0x2002F

; -------------------------------------------------
        MACRO
$label  SIGNATURE
        ALIGN   4
        =       "$label",0
        ALIGN   4
        DCD     &FF000000+(:LEN:"$label"+4):AND::NOT:3
$label
        MEND

; Data for the rows of the hourglass
rowdata
          DCD     &00000000, &00000000
          DCD     &55400000, &00000155
          DCD     &55540000, &00001555
          DCD     &aa550000, &000055aa
          DCD     &55550000, &00015555
          DCD     &55550000, &00005555
          DCD     &55500000, &00000555
          DCD     &a5000000, &0000005a
          DCD     &94000000, &00000016
          DCD     &a9400000, &0000016a
          DCD     &aa500000, &000005aa
          DCD     &aa940000, &000016aa
          DCD     &aaa50000, &00005aaa
          DCD     &aaa90000, &00006aaa
          DCD     &aaa90000, &00016aaa
          DCD     &55690000, &00016955
          DCD     &a9550000, &0001555a
          DCD     &aaa50000, &000156aa
          DCD     &aa950000, &000056aa
          DCD     &95540000, &00001556
          DCD     &5aa50000, &00015655
          DCD     &55000000, &00000055
          DCD     &54000000, &00000015
          DCD     &aaa50000, &00015aaa
          DCD     &65000000, &0000005a
          DCD     &69400000, &0000016a
          DCD     &6a500000, &000005aa
          DCD     &aa950000, &000156aa
          DCD     &a5000000, &00000059
          DCD     &a9400000, &00000169
          DCD     &aa500000, &000005a9
          DCD     &aa940000, &000016a9
          DCD     &aaa50000, &00005aa9
          DCD     &aaa90000, &00006aa9
          DCD     &6aa90000, &00016aa9
          DCD     &69550000, &00015559
          DCD     &6aa50000, &000156a9
          DCD     &5a950000, &000056a5
          DCD     &55a50000, &00016a55
          DCD     &a9550000, &000056aa
          DCD     &55a50000, &00015655
          DCD     &55a90000, &00016a55
          DCD     &aaa50000, &00006aaa
          DCD     &5aa90000, &00016aa5
          DCD     &aa950000, &00005aaa
          DCD     &a9540000, &000015aa
          DCD     &6aa50000, &00005aa9
          DCD     &55a90000, &00006a55
          DCD     &55590000, &00016955
          DCD     &55550000, &00016555
          DCD     &aa540000, &000016aa
          DCD     &a5500000, &0000056a
          DCD     &6a940000, &000016a9
          DCD     &55550000, &00005955
          DCD     &a9500000, &000005aa
          DCD     &95400000, &0000015a
          DCD     &6a500000, &000005a9
          DCD     &aa954000, &000056aa
          DCD     &aaa94000, &000056aa
          DCD     &aa954000, &000055aa
          DCD     &55554000, &00005955
          DCD     &55694000, &00005a95
          DCD     &aaa94000, &00005aaa
          DCD     &aaa50000, &000016aa
          DCD     &aaa50000, &000015aa
          DCD     &aa540000, &000005aa
          DCD     &a9500000, &0000016a
          DCD     &96000000, &00000016
          DCD     &94000000, &00000096
          DCD     &a9400000, &0000056a
          DCD     &a9500000, &000015aa
          DCD     &55540000, &00005555
          DCD     &aa954000, &000016aa
          DCD     &aaa95000, &000015aa
          DCD     &aaa95000, &0000156a
          DCD     &5a555000, &00001a55
          DCD     &55555000, &00001aa5
          DCD     &aaaa5000, &000016aa
          DCD     &aaa94000, &000016aa
          DCD     &aaa54000, &000005aa
          DCD     &aa950000, &0000016a
          DCD     &aa500000, &0000005a
          DCD     &a9400000, &0000005a
          DCD     &a5000000, &00000016
          DCD     &94000000, &00000056
          DCD     &94000000, &0000016a
          DCD     &a5000000, &000015aa
          DCD     &a5400000, &000056aa
          DCD     &55500000, &00015555
          DCD     &55540000, &00015555
          DCD     &55540000, &00055555
          DCD     &55400000, &00000055
          DCD     &55540000, &00000155
          DCD     &aa954000, &0000015a
          DCD     &aaa95000, &0000015a
          DCD     &aaaa5400, &00000595
          DCD     &5aaa9500, &000005a9
          DCD     &55555500, &000005aa
          DCD     &a9555400, &0000016a
          DCD     &aaaa9400, &0000016a
          DCD     &aaaa9400, &0000005a
          DCD     &aaaa5000, &0000005a
          DCD     &aaa54000, &00000016
          DCD     &aa550000, &00000016
          DCD     &a5500000, &00000006
          DCD     &95000000, &00000016
          DCD     &90000000, &0000015a
          DCD     &94000000, &000015aa
          DCD     &94000000, &00015aaa
          DCD     &55000000, &00055aa9
          DCD     &55000000, &00155555
          DCD     &55400000, &00155555
          DCD     &55400000, &00555555
          DCD     &55500000, &00555555
          DCD     &55500000, &00155555
          DCD     &55400000, &00055555
          DCD     &55400000, &00015555
          DCD     &55400000, &00001555
          DCD     &55000000, &00000155
          DCD     &55540000, &0000155a
          DCD     &aaaa5000, &0000155a
          DCD     &55555000, &000016a9
          DCD     &aaa94000, &000005aa
          DCD     &aa540000, &0000005a
          DCD     &a9400000, &00000016
          DCD     &94000000, &0000005a
          DCD     &a5400000, &000055aa
          DCD     &55500000, &00001555
          DCD     &aa950000, &00016aaa
          DCD     &a9550000, &00015aaa
          DCD     &55650000, &00015555
          DCD     &56a50000, &00016955
          DCD     &aaa50000, &00016aaa
          DCD     &aa940000, &00005aaa
          DCD     &aa540000, &000056aa
          DCD     &a5400000, &0000005a
          DCD     &aa540000, &0000055a
          DCD     &55550000, &00001555
          DCD     &55554000, &00005555
          DCD     &95400000, &00001556
          DCD     &a9400000, &000156aa
          DCD     &a5500000, &00056aaa
          DCD     &56500000, &0015aaaa
          DCD     &5a500000, &0016aaa5
          DCD     &aa500000, &00155555
          DCD     &aa500000, &0015556a
          DCD     &a9400000, &0016aaaa
          DCD     &a9400000, &0005aaaa
          DCD     &a5000000, &00056aaa
          DCD     &94000000, &000056aa
          DCD     &98000000, &0000015a
          DCD     &a5400000, &00000016
          DCD     &aa540000, &00000016
          DCD     &aa954000, &0000001a
          DCD     &aa555000, &00000056
          DCD     &55555000, &00000155
          DCD     &55555400, &00000155
          DCD     &55555400, &00000555
          DCD     &55555000, &00000555
          DCD     &55554000, &00000155
          DCD     &50000000, &00000155
          DCD     &50000000, &00001555
          DCD     &54000000, &000156a9
          DCD     &54000000, &00056aa9
          DCD     &a5000000, &0015aaa5
          DCD     &a5000000, &005aaa96
          DCD     &a5000000, &015aa95a
          DCD     &a4000000, &016a956a
          DCD     &94000000, &015556aa
          DCD     &94000000, &01556aaa
          DCD     &90000000, &005aaaaa
          DCD     &50000000, &005aaaaa
          DCD     &58000000, &00156aaa
          DCD     &58000000, &000555aa
          DCD     &96000000, &00000556
          DCD     &a5540000, &00000016
          DCD     &aa555000, &00000025
          DCD     &aaaa5400, &00000005
          DCD     &aaa95500, &00000006
          DCD     &55555500, &00000005
          DCD     &55555540, &00000015
          DCD     &55555540, &00000055
          DCD     &55555500, &00000055
          DCD     &55555400, &00000055
          DCD     &55555000, &00000015
          DCD     &55554000, &00000015
          DCD     &55540000, &00000005
          DCD     &55400000, &00000001
          DCD     &00000000, &00000140
          DCD     &00000000, &00001550
          DCD     &00000000, &00015554
          DCD     &00000000, &00056a55
          DCD     &40000000, &0016a969
          DCD     &40000000, &005aa969
          DCD     &40000000, &015aa5a9
          DCD     &40000000, &016aa5aa
          DCD     &40000000, &05aa96aa
          DCD     &40000000, &05aa5aaa
          DCD     &40000000, &16a56aaa
          DCD     &40000000, &1556aaaa
          DCD     &40000000, &155aaaaa
          DCD     &54000000, &056aaaaa
          DCD     &95555500, &0156aaaa
          DCD     &aaa95540, &00155556
          DCD     &aaa55550, &00000005
          DCD     &a5555554, &00000001
          DCD     &55555554, &00000001
          DCD     &55555550, &00000001
          DCD     &55555540, &00000001
          DCD     &55555500, &00000001
          DCD     &55555400, &00000001
          DCD     &55555000, &00000000
          DCD     &15554000, &00000000
          DCD     &05540000, &00000000
          DCD     &01000000, &00000000
          DCD     &00000000, &00015000
          DCD     &00000000, &00055500
          DCD     &00000000, &00155550
          DCD     &00000000, &005a5a50
          DCD     &00000000, &016a5a94
          DCD     &00000000, &05aa5aa4
          DCD     &00000000, &05aa6aa4
          DCD     &00000000, &16a96aa5
          DCD     &00055500, &16a96aa9
          DCD     &60555550, &16a5aaa9
          DCD     &555a5554, &16a6aaaa
          DCD     &aaa55554, &1696aaaa
          DCD     &aa555554, &155aaa96
          DCD     &65555554, &156aa555
          DCD     &55555554, &05555509
          DCD     &55555554, &00554000
          DCD     &55555554, &00000000
          DCD     &15555550, &00000000
          DCD     &15555540, &00000000
          DCD     &05555540, &00000000
          DCD     &05555500, &00000000
          DCD     &01555400, &00000000
          DCD     &00555000, &00000000
          DCD     &00054000, &00000000
          DCD     &00000000, &00555000
          DCD     &00000000, &01555400
          DCD     &00000000, &0156a500
          DCD     &00015540, &05a6a940
          DCD     &00155550, &05a5a940
          DCD     &00555554, &16a5aa50
          DCD     &01695554, &16a5aa94
          DCD     &55a55554, &16a5aaa5
          DCD     &56a55554, &16a5aaa9
          DCD     &aa955554, &16a5aaaa
          DCD     &aa555554, &16a6aaaa
          DCD     &69555554, &16a6aa95
          DCD     &55555554, &1696aa55
          DCD     &15555554, &169aa940
          DCD     &05555554, &155a9500
          DCD     &01555550, &05595400
          DCD     &01555550, &01554000
          DCD     &00555540, &00000000
          DCD     &00155540, &00000000
          DCD     &00055500, &00000000
          DCD     &00001400, &00000000
          DCD     &00155500, &00000000
          DCD     &01555540, &00000000
          DCD     &01555550, &00150000
          DCD     &05955550, &05555000
          DCD     &06955554, &056a5400
          DCD     &16955554, &156aa540
          DCD     &5a955554, &165aa955
          DCD     &6a955554, &1696aa95
          DCD     &aa555554, &1696aaaa
          DCD     &55555554, &16a5aaa9
          DCD     &55555554, &16a5aaa5
          DCD     &01555554, &16a5aa94
          DCD     &00155554, &16a9aa90
          DCD     &00055550, &05a9aa50
          DCD     &00005400, &05a9a940
          DCD     &00000000, &0165a540
          DCD     &00000000, &01555500
          DCD     &00000000, &00555400
          DCD     &00000000, &00150000
          DCD     &00140000, &00000000
          DCD     &01554000, &00000000
          DCD     &05555000, &00000000
          DCD     &15555400, &00000000
          DCD     &15555500, &00000000
          DCD     &59555540, &00000000
          DCD     &59555550, &00000000
          DCD     &69555554, &00000000
          DCD     &69555554, &00000001
          DCD     &65555554, &00555429
          DCD     &a5555554, &01555555
          DCD     &a5555554, &15aaaa56
          DCD     &95555550, &15aaaaaa
          DCD     &55555540, &155aaaaa
          DCD     &40055400, &1656aaa9
          DCD     &40000000, &16a5aaa9
          DCD     &00000000, &16a96aa9
          DCD     &00000000, &05a96aa5
          DCD     &00000000, &05aa5aa5
          DCD     &00000000, &016a9aa5
          DCD     &00000000, &015a96a5
          DCD     &00000000, &005aa694
          DCD     &00000000, &0015a554
          DCD     &00000000, &00055550
          DCD     &00000000, &00015500
          DCD     &00000000, &00000400
          DCD     &55540000, &00000001
          DCD     &55554000, &00000005
          DCD     &55555400, &00000015
          DCD     &55555500, &00000016
          DCD     &95555540, &00000016
          DCD     &a5555540, &00000016
          DCD     &a5555550, &00000016
          DCD     &a9555550, &00000006
          DCD     &a9555540, &00000005
          DCD     &a5555500, &00000005
          DCD     &a5555400, &00000005
          DCD     &a5554000, &00000016
          DCD     &95000000, &0001555a
          DCD     &50000000, &001556aa
          DCD     &50000000, &0056aaaa
          DCD     &90000000, &016aaaaa
          DCD     &90000000, &0555aaaa
          DCD     &94000000, &05555aaa
          DCD     &94000000, &016a55aa
          DCD     &94000000, &016aa56a
          DCD     &94000000, &005aaa5a
          DCD     &94000000, &0016aa96
          DCD     &94000000, &00056aa5
          DCD     &50000000, &000156a9
          DCD     &40000000, &00001555
          DCD     &40000000, &00000155
          DCD     &55540000, &00000555
          DCD     &55554000, &00001555
          DCD     &55555000, &00001555
          DCD     &55555000, &000016aa
          DCD     &55555000, &000005aa
          DCD     &55554000, &000005aa
          DCD     &95550000, &0000016a
          DCD     &95540000, &0000005a
          DCD     &95500000, &00000016
          DCD     &a9400000, &000056aa
          DCD     &aa500000, &00016aaa
          DCD     &aa500000, &0005aaaa
          DCD     &aa940000, &0005aaaa
          DCD     &5a940000, &00055555
          DCD     &55940000, &00056aaa
          DCD     &a9540000, &00056aaa
          DCD     &aa540000, &000156aa
          DCD     &95500000, &00001555
          DCD     &55000000, &00055555
          DCD     &54000000, &000156aa
          DCD     &54000000, &000055aa
          DCD     &a5400000, &00000006
          DCD     &a5555500, &000005aa
          DCD     &55aa9500, &000005aa
          DCD     &6aaa5400, &000005a5
          DCD     &aaa95000, &00000155
          DCD     &95540000, &00000156
          DCD     &55500000, &00055555
          DCD     &55540000, &00155555
          DCD     &55000000, &00015555
          DCD     &95000000, &000055aa
          DCD     &94000000, &0000056a
          DCD     &94000000, &0000015a
          DCD     &a9500000, &00000016
          DCD     &aa950000, &0000005a
          DCD     &aaa54000, &0000005a
          DCD     &aaa95000, &0000016a
          DCD     &aaaa5000, &000005aa
          DCD     &aaaa9000, &000005aa
          DCD     &95555400, &000016aa
          DCD     &55555400, &000016a5
          DCD     &6aaa5400, &00001695
          DCD     &aaa95000, &0000055a
          DCD     &aa954000, &0000056a
          DCD     &55540000, &00000556
          DCD     &55550000, &00055555
          DCD     &55500000, &00005555
          DCD     &55400000, &0000155a
          DCD     &a5000000, &0000056a
          DCD     &aaaa4000, &000016aa
          DCD     &aaaa5000, &00005aaa
          DCD     &55555000, &00005a95
          DCD     &aaa95000, &00001556
          DCD     &aa954000, &000015aa
          DCD     &aa500000, &0000055a
          DCD     &aaa94000, &00006aaa
          DCD     &55694000, &00006955
          DCD     &a9554000, &0000555a
          DCD     &aaa54000, &000056aa
          DCD     &59500000, &00000555
          DCD     &a9400000, &0000015a

; Data for deltas between frames
deltas
          ; frame 0
          DCD     0, 0
          DCD     8, 8
          DCD     16, 16
          DCD     24, 24
          DCD     32, 32
          DCD     40, 32
          DCD     48, 32
          DCD     56, 32
          DCD     64, 40
          DCD     72, 40
          DCD     80, 16
          DCD     88, 48
          DCD     96, 8
          DCD     104, 56
          DCD     112, 64
          DCD     120, 64
          DCD     128, 64
          DCD     136, 64
          DCD     144, 56
          DCD     152, 72
          DCD     160, 80
          DCD     168, 88
          DCD     176, 96
          DCD     184, 104
          DCD     192, 112
          DCD     200, 120
          DCD     208, 128
          DCD     216, 136
          DCD     224, 144
          DCD     232, 152
          DCD     240, 8
          DCD     248, 0
          DCD     -1, -1
          ; frame 1
          DCD     -1, -1
          ; frame 2
          DCD     24, 144
          DCD     32, 160
          DCD     104, 168
          DCD     112, 176
          DCD     120, 176
          DCD     128, 176
          DCD     -1, -1
          ; frame 3
          DCD     -1, -1
          ; frame 4
          DCD     32, 184
          DCD     136, 176
          DCD     144, 192
          DCD     152, 200
          DCD     160, 208
          DCD     -1, -1
          ; frame 5
          DCD     -1, -1
          ; frame 6
          DCD     40, 216
          DCD     144, 224
          DCD     152, 232
          DCD     160, 240
          DCD     168, 248
          DCD     176, 256
          DCD     184, 264
          DCD     192, 272
          DCD     208, 280
          DCD     -1, -1
          ; frame 7
          DCD     -1, -1
          ; frame 8
          DCD     216, 288
          DCD     224, 296
          DCD     232, 16
          DCD     -1, -1
          ; frame 9
          DCD     -1, -1
          ; frame 10
          DCD     56, 304
          DCD     64, 312
          DCD     208, 32
          DCD     216, 320
          DCD     224, 40
          DCD     -1, -1
          ; frame 11
          DCD     -1, -1
          ; frame 12
          DCD     56, 328
          DCD     64, 336
          DCD     72, 312
          DCD     192, 344
          DCD     216, 32
          DCD     -1, -1
          ; frame 13
          DCD     -1, -1
          ; frame 14
          DCD     72, 352
          DCD     80, 360
          DCD     176, 368
          DCD     184, 376
          DCD     192, 384
          DCD     200, 392
          DCD     -1, -1
          ; frame 15
          DCD     -1, -1
          ; frame 16
          DCD     64, 104
          DCD     72, 96
          DCD     80, 400
          DCD     88, 408
          DCD     168, 416
          DCD     176, 424
          DCD     184, 40
          DCD     192, 32
          DCD     200, 32
          DCD     -1, -1
          ; frame 17
          DCD     -1, -1
          ; frame 18
          DCD     80, 88
          DCD     88, 432
          DCD     96, 440
          DCD     160, 448
          DCD     168, 16
          DCD     176, 40
          DCD     -1, -1
          ; frame 19
          DCD     -1, -1
          ; frame 20
          DCD     88, 80
          DCD     96, 72
          DCD     104, 56
          DCD     112, 64
          DCD     120, 64
          DCD     128, 64
          DCD     136, 64
          DCD     144, 56
          DCD     152, 72
          DCD     160, 80
          DCD     -1, -1
          ; frame 21
          DCD     -1, -1
          ; frame 22
          DCD     -1, -1
          ; frame 23
          DCD     -1, -1
          ; frame 24
          DCD     -1, -1
          ; frame 25
          DCD     -1, -1
          ; frame 26
          DCD     -1, -1
          ; frame 27
          DCD     -1, -1
          ; frame 28
          DCD     -1, -1
          ; frame 29
          DCD     -1, -1
          ; frame 30
          DCD     24, 456
          DCD     32, 464
          DCD     40, 472
          DCD     48, 480
          DCD     56, 488
          DCD     64, 496
          DCD     72, 504
          DCD     80, 512
          DCD     88, 520
          DCD     96, 528
          DCD     112, 536
          DCD     136, 544
          DCD     152, 552
          DCD     160, 560
          DCD     168, 568
          DCD     176, 568
          DCD     184, 32
          DCD     224, 32
          DCD     -1, -1
          ; frame 31
          DCD     24, 576
          DCD     32, 584
          DCD     40, 592
          DCD     48, 600
          DCD     56, 608
          DCD     64, 616
          DCD     72, 624
          DCD     80, 632
          DCD     88, 640
          DCD     96, 648
          DCD     104, 656
          DCD     112, 664
          DCD     136, 672
          DCD     144, 680
          DCD     152, 688
          DCD     160, 696
          DCD     168, 704
          DCD     176, 712
          DCD     184, 720
          DCD     192, 720
          DCD     200, 720
          DCD     208, 720
          DCD     216, 720
          DCD     224, 712
          DCD     -1, -1
          ; frame 32
          DCD     8, 728
          DCD     16, 736
          DCD     24, 744
          DCD     32, 752
          DCD     40, 760
          DCD     48, 768
          DCD     56, 776
          DCD     64, 784
          DCD     72, 792
          DCD     80, 800
          DCD     88, 808
          DCD     96, 816
          DCD     104, 824
          DCD     112, 832
          DCD     120, 840
          DCD     128, 672
          DCD     136, 848
          DCD     144, 856
          DCD     152, 864
          DCD     160, 872
          DCD     168, 880
          DCD     176, 888
          DCD     184, 888
          DCD     192, 896
          DCD     200, 904
          DCD     208, 912
          DCD     216, 920
          DCD     224, 928
          DCD     232, 936
          DCD     240, 944
          DCD     -1, -1
          ; frame 33
          DCD     8, 8
          DCD     16, 952
          DCD     24, 576
          DCD     32, 584
          DCD     40, 960
          DCD     48, 600
          DCD     56, 968
          DCD     64, 616
          DCD     72, 976
          DCD     80, 632
          DCD     88, 640
          DCD     96, 984
          DCD     104, 992
          DCD     112, 840
          DCD     120, 64
          DCD     128, 64
          DCD     136, 1000
          DCD     144, 680
          DCD     152, 688
          DCD     160, 1008
          DCD     168, 704
          DCD     176, 704
          DCD     184, 720
          DCD     192, 720
          DCD     200, 720
          DCD     208, 720
          DCD     216, 720
          DCD     224, 712
          DCD     232, 1016
          DCD     -1, -1
          ; frame 34
          DCD     16, 16
          DCD     24, 216
          DCD     32, 1024
          DCD     40, 1032
          DCD     48, 1040
          DCD     56, 1048
          DCD     64, 1056
          DCD     72, 1064
          DCD     80, 1072
          DCD     88, 560
          DCD     96, 72
          DCD     104, 56
          DCD     112, 64
          DCD     136, 536
          DCD     144, 1080
          DCD     152, 528
          DCD     160, 1088
          DCD     168, 1096
          DCD     176, 1096
          DCD     184, 1104
          DCD     192, 1104
          DCD     200, 1104
          DCD     208, 1104
          DCD     216, 1104
          DCD     224, 1104
          DCD     232, 16
          DCD     240, 728
          DCD     -1, -1
          ; frame 35
          DCD     8, 944
          DCD     16, 1112
          DCD     24, 1120
          DCD     32, 1128
          DCD     40, 1136
          DCD     48, 1144
          DCD     56, 1152
          DCD     64, 1160
          DCD     72, 1168
          DCD     80, 1176
          DCD     88, 1184
          DCD     96, 1192
          DCD     104, 856
          DCD     112, 1200
          DCD     120, 544
          DCD     128, 840
          DCD     136, 1208
          DCD     144, 1216
          DCD     152, 1224
          DCD     160, 1232
          DCD     168, 1240
          DCD     176, 1248
          DCD     184, 1256
          DCD     192, 1256
          DCD     200, 1256
          DCD     208, 1256
          DCD     216, 1264
          DCD     224, 1272
          DCD     232, 736
          DCD     -1, -1
          ; frame 36
          DCD     8, 1280
          DCD     16, 1288
          DCD     24, 1296
          DCD     32, 1304
          DCD     40, 1312
          DCD     48, 1320
          DCD     56, 1328
          DCD     64, 1336
          DCD     72, 1344
          DCD     80, 1352
          DCD     88, 1360
          DCD     96, 1368
          DCD     104, 1376
          DCD     112, 1384
          DCD     120, 1392
          DCD     128, 1400
          DCD     136, 1408
          DCD     144, 1416
          DCD     152, 1424
          DCD     160, 1432
          DCD     168, 1440
          DCD     176, 1440
          DCD     184, 1440
          DCD     192, 1448
          DCD     200, 1456
          DCD     208, 1464
          DCD     216, 1472
          DCD     224, 1480
          DCD     232, 1488
          DCD     240, 1496
          DCD     -1, -1
          ; frame 37
          DCD     8, 1504
          DCD     16, 1512
          DCD     24, 1520
          DCD     32, 1528
          DCD     40, 1536
          DCD     48, 1544
          DCD     56, 1552
          DCD     64, 1560
          DCD     72, 1568
          DCD     80, 1576
          DCD     88, 1584
          DCD     96, 1592
          DCD     104, 1600
          DCD     112, 1608
          DCD     120, 1616
          DCD     128, 1624
          DCD     136, 1632
          DCD     144, 1640
          DCD     152, 1648
          DCD     160, 1648
          DCD     168, 1656
          DCD     176, 1656
          DCD     184, 1664
          DCD     192, 1664
          DCD     200, 1672
          DCD     208, 1680
          DCD     216, 1688
          DCD     224, 1696
          DCD     232, 1704
          DCD     240, 1712
          DCD     -1, -1
          ; frame 38
          DCD     8, 0
          DCD     16, 0
          DCD     24, 1720
          DCD     32, 1728
          DCD     40, 1736
          DCD     48, 1744
          DCD     56, 1752
          DCD     64, 1752
          DCD     72, 1760
          DCD     80, 1768
          DCD     88, 1776
          DCD     96, 1784
          DCD     104, 1792
          DCD     112, 1800
          DCD     120, 1808
          DCD     128, 1816
          DCD     136, 1824
          DCD     144, 1832
          DCD     152, 1840
          DCD     160, 1848
          DCD     168, 1856
          DCD     176, 1856
          DCD     184, 1864
          DCD     192, 1872
          DCD     200, 1880
          DCD     208, 1888
          DCD     216, 1896
          DCD     224, 1904
          DCD     232, 0
          DCD     240, 0
          DCD     -1, -1
          ; frame 39
          DCD     24, 0
          DCD     32, 0
          DCD     40, 0
          DCD     48, 1912
          DCD     56, 1920
          DCD     64, 1928
          DCD     72, 1936
          DCD     80, 1944
          DCD     88, 1952
          DCD     96, 1960
          DCD     104, 1968
          DCD     112, 1976
          DCD     120, 1984
          DCD     128, 1992
          DCD     136, 2000
          DCD     144, 2008
          DCD     152, 2016
          DCD     160, 2024
          DCD     168, 2032
          DCD     176, 2040
          DCD     184, 2048
          DCD     192, 2056
          DCD     200, 2064
          DCD     208, 0
          DCD     216, 0
          DCD     224, 0
          DCD     -1, -1
          ; frame 40
          DCD     40, 2072
          DCD     48, 2080
          DCD     56, 2048
          DCD     64, 2088
          DCD     72, 2096
          DCD     80, 2104
          DCD     88, 2112
          DCD     96, 2120
          DCD     104, 2128
          DCD     112, 2136
          DCD     120, 2144
          DCD     136, 2152
          DCD     144, 2160
          DCD     152, 2168
          DCD     160, 2176
          DCD     168, 2184
          DCD     176, 2192
          DCD     184, 2200
          DCD     192, 2208
          DCD     200, 2216
          DCD     208, 2224
          DCD     -1, -1
          ; frame 41
          DCD     16, 2232
          DCD     24, 2240
          DCD     32, 2248
          DCD     40, 2256
          DCD     48, 2264
          DCD     56, 1864
          DCD     64, 2272
          DCD     72, 2280
          DCD     80, 2280
          DCD     88, 2288
          DCD     96, 2296
          DCD     104, 2304
          DCD     112, 2312
          DCD     120, 2320
          DCD     128, 2328
          DCD     136, 2336
          DCD     144, 2344
          DCD     152, 2352
          DCD     160, 2360
          DCD     168, 2368
          DCD     176, 2376
          DCD     184, 2384
          DCD     192, 2392
          DCD     200, 2400
          DCD     208, 2408
          DCD     216, 2416
          DCD     224, 2424
          DCD     232, 2432
          DCD     -1, -1
          ; frame 42
          DCD     8, 1496
          DCD     16, 2440
          DCD     24, 2448
          DCD     32, 1472
          DCD     40, 2456
          DCD     48, 2464
          DCD     56, 2472
          DCD     64, 2480
          DCD     72, 2488
          DCD     80, 2496
          DCD     88, 2504
          DCD     96, 2504
          DCD     104, 2512
          DCD     112, 2520
          DCD     120, 2528
          DCD     128, 2536
          DCD     136, 2544
          DCD     144, 2552
          DCD     152, 1368
          DCD     160, 2560
          DCD     168, 2568
          DCD     176, 2576
          DCD     184, 2584
          DCD     192, 2592
          DCD     200, 2600
          DCD     208, 2608
          DCD     216, 2616
          DCD     224, 2624
          DCD     232, 2632
          DCD     240, 2640
          DCD     -1, -1
          ; frame 43
          DCD     8, 8
          DCD     16, 2648
          DCD     24, 2656
          DCD     32, 2664
          DCD     40, 2664
          DCD     48, 2664
          DCD     56, 2664
          DCD     64, 2672
          DCD     72, 2680
          DCD     80, 2688
          DCD     88, 2696
          DCD     96, 2704
          DCD     104, 2712
          DCD     112, 840
          DCD     120, 536
          DCD     128, 64
          DCD     136, 1000
          DCD     144, 680
          DCD     152, 688
          DCD     160, 2720
          DCD     168, 2728
          DCD     176, 2736
          DCD     184, 2744
          DCD     192, 2744
          DCD     200, 2752
          DCD     208, 2760
          DCD     216, 2768
          DCD     224, 2776
          DCD     232, 2784
          DCD     240, 8
          DCD     -1, -1
          ; frame 44
          DCD     8, 944
          DCD     16, 936
          DCD     24, 928
          DCD     32, 920
          DCD     40, 912
          DCD     48, 904
          DCD     56, 904
          DCD     64, 888
          DCD     72, 888
          DCD     80, 880
          DCD     88, 2792
          DCD     96, 2800
          DCD     104, 2808
          DCD     112, 848
          DCD     120, 672
          DCD     128, 840
          DCD     136, 2816
          DCD     144, 1216
          DCD     152, 816
          DCD     160, 808
          DCD     168, 800
          DCD     176, 792
          DCD     184, 792
          DCD     192, 2824
          DCD     200, 2832
          DCD     208, 2840
          DCD     216, 2848
          DCD     224, 744
          DCD     232, 2856
          DCD     240, 728
          DCD     -1, -1
          ; frame 45
          DCD     8, 8
          DCD     16, 1016
          DCD     24, 704
          DCD     32, 2864
          DCD     48, 2872
          DCD     56, 2872
          DCD     64, 2864
          DCD     72, 2864
          DCD     80, 920
          DCD     88, 2880
          DCD     96, 2888
          DCD     104, 2896
          DCD     112, 2904
          DCD     120, 544
          DCD     128, 64
          DCD     136, 664
          DCD     144, 2912
          DCD     152, 2920
          DCD     160, 2928
          DCD     168, 2936
          DCD     176, 2944
          DCD     184, 2952
          DCD     192, 2960
          DCD     200, 2968
          DCD     208, 2976
          DCD     216, 2984
          DCD     224, 2992
          DCD     232, 3000
          DCD     240, 8
          DCD     -1, -1
          ; frame 46
          DCD     16, 16
          DCD     24, 712
          DCD     32, 720
          DCD     40, 720
          DCD     48, 3008
          DCD     56, 3008
          DCD     64, 712
          DCD     72, 712
          DCD     80, 3016
          DCD     88, 3024
          DCD     96, 3032
          DCD     104, 2904
          DCD     112, 672
          DCD     120, 64
          DCD     144, 656
          DCD     152, 648
          DCD     160, 640
          DCD     168, 632
          DCD     176, 624
          DCD     184, 3040
          DCD     192, 3048
          DCD     200, 3056
          DCD     208, 3064
          DCD     216, 592
          DCD     224, 3072
          DCD     232, 16
          DCD     -1, -1
          ; frame 47
          DCD     24, 40
          DCD     32, 32
          DCD     40, 32
          DCD     48, 32
          DCD     56, 32
          DCD     64, 32
          DCD     72, 40
          DCD     80, 16
          DCD     88, 3080
          DCD     96, 72
          DCD     104, 56
          DCD     112, 64
          DCD     136, 64
          DCD     144, 56
          DCD     152, 72
          DCD     160, 80
          DCD     168, 88
          DCD     176, 96
          DCD     184, 496
          DCD     192, 3088
          DCD     200, 3096
          DCD     208, 3104
          DCD     216, 3112
          DCD     224, 144
          DCD     232, 152
          DCD     -1, -1
          ; frame 48
          DCD     64, 40
          DCD     88, 3120
          DCD     96, 3128
          DCD     184, 104
          DCD     192, 112
          DCD     200, 120
          DCD     208, 128
          DCD     216, 136
          DCD     -1, -1

; Offsets into the deltas for each frame
frame_deltas
          DCD     0  ; frame 0
          DCD     264  ; frame 1
          DCD     272  ; frame 2
          DCD     328  ; frame 3
          DCD     336  ; frame 4
          DCD     384  ; frame 5
          DCD     392  ; frame 6
          DCD     472  ; frame 7
          DCD     480  ; frame 8
          DCD     512  ; frame 9
          DCD     520  ; frame 10
          DCD     568  ; frame 11
          DCD     576  ; frame 12
          DCD     624  ; frame 13
          DCD     632  ; frame 14
          DCD     688  ; frame 15
          DCD     696  ; frame 16
          DCD     776  ; frame 17
          DCD     784  ; frame 18
          DCD     840  ; frame 19
          DCD     848  ; frame 20
          DCD     936  ; frame 21
          DCD     944  ; frame 22
          DCD     952  ; frame 23
          DCD     960  ; frame 24
          DCD     968  ; frame 25
          DCD     976  ; frame 26
          DCD     984  ; frame 27
          DCD     992  ; frame 28
          DCD     1000  ; frame 29
          DCD     1008  ; frame 30
          DCD     1160  ; frame 31
          DCD     1360  ; frame 32
          DCD     1608  ; frame 33
          DCD     1848  ; frame 34
          DCD     2072  ; frame 35
          DCD     2312  ; frame 36
          DCD     2560  ; frame 37
          DCD     2808  ; frame 38
          DCD     3056  ; frame 39
          DCD     3272  ; frame 40
          DCD     3448  ; frame 41
          DCD     3680  ; frame 42
          DCD     3928  ; frame 43
          DCD     4176  ; frame 44
          DCD     4424  ; frame 45
          DCD     4664  ; frame 46
          DCD     4880  ; frame 47
          DCD     5088  ; frame 48

; Palette data
palette
          DCB     24, 154, 248
          DCB     173, 219, 230
          ALIGN

; Read the period between frames
; <=  R0 = cs between frames
hourglass_getframeperiod SIGNATURE
          EXPORT  hourglass_getframeperiod
          MOV     r0, #period
          MOV     pc, lr


; Read the size of the workspace block
; <=  R0 = size of hourglass workspace
hourglass_getwssize SIGNATURE
          EXPORT  hourglass_getwssize
          MOV     r0, #hg_workspacesize
          MOV     pc, lr

; Initialisation function
; =>  R0 = hourglass workspace
hourglass_init SIGNATURE
          EXPORT  hourglass_init
          MOV     r12, r0
          MOV     r0, #0
          STR     r0, hg_framenum
          STR     r0, hg_percentage
          STR     r0, hg_leds
          LDR     r0, wordblock_0
          STR     r0, hg_word
          LDR     r0, wordblock_4
          ADR     r1, hg_currentdata
          ORR     r0, r0, r1, LSL #16         ; assign the low half word of pointer data
          STR     r0, hg_word + 4
          MOV     r0, r1, LSR #16             ; and the high half word
          STR     r0, hg_word + 8
; no need to initialise the currentdata; it will be updated by the first frame
          MOV     pc, lr

wordblock_0
          DCB     0                           ; define pointer shape
          DCB     2                           ; shape number (will toggle 2-3)
          DCB     (width*2+7)/8               ; width in bytes
          DCB     height                      ; height
wordblock_4
          DCB     active_x                    ; active x offset
          DCB     active_y                    ; active y offset
          DCB     0                           ; b0-7 of the address of the pointer data
          DCB     0                           ; b8-15 of address of the pointer data

; Start the hourglass
; =>  R0 = hourglass workspace
hourglass_start SIGNATURE
          EXPORT  hourglass_start
          STMFD   sp!, {r4, r5, lr}
          SUB     sp, sp, #8
          MOV     r12, r0
          MOV     r0, #0
          STR     r0, hg_framenum
          MOV     r0, #1
          MOV     r1, #25                     ; read pointer colour 1
          SWI     XOS_ReadPalette
          LDRVS   r2, =&81397900              ; purple if it wasn't set
          STR     r2, hg_oldcolours + 4 * 0
          MOV     r0, #2
          MOV     r1, #25                     ; read pointer colour 2
          SWI     XOS_ReadPalette
          LDRVS   r2, =&66FFFF00              ; yellow if it wasn't set
          STR     r2, hg_oldcolours + 4 * 1
          MOV     r0, #3
          MOV     r1, #25                     ; read pointer colour 3
          SWI     XOS_ReadPalette
          LDRVS   r2, =&00000000              ; black if it wasn't set
          STR     r2, hg_oldcolours + 4 * 2
; now set the palette up for our hourglass
          MOV     r1, sp
          ADRL    r2, palette
; colour 1
          MOV     r0, #1
          STRB    r0, [r1, #0]
          MOV     r0, #25                     ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                ; blue
          MOV     r0, #12
          SWI     XOS_Word                    ; Set palette
; colour 2
          MOV     r0, #2
          STRB    r0, [r1, #0]
          MOV     r0, #25                     ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                ; blue
          MOV     r0, #12
          SWI     XOS_Word                    ; Set palette
          MOV     r1, #127                        ; invalid pointer number to read the pointer
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte
          MOVVS   r1, #0                          ; if there was an error, turn off
          STR     r1, hg_oldpointer
          ADD     sp, sp, #8
          LDMFD   sp!, {r4, r5, lr}
          MOV     r0, r12
          B       hourglass_frame                 ; exit via the first frame

; Stop the hourglass
; =>  R0 = hourglass workspace
hourglass_stop SIGNATURE
          EXPORT  hourglass_stop
          STMFD   sp!, {r4, r5, lr}
          SUB     sp, sp, #8
          MOV     r12, r0
; restore the palette up for old pointer
          MOV     r1, sp
; colour 1
          ADR     r2, hg_oldcolours + 4 * 0 + 1
          MOV     r0, #1
          STRB    r0, [r1, #0]
          MOV     r0, #25                         ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                    ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                    ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                    ; blue
          MOV     r0, #12
          SWI     XOS_Word                        ; Set palette
; colour 2
          ADR     r2, hg_oldcolours + 4 * 1 + 1
          MOV     r0, #2
          STRB    r0, [r1, #0]
          MOV     r0, #25                         ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                    ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                    ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                    ; blue
          MOV     r0, #12
          SWI     XOS_Word                        ; Set palette
          LDR     r1, hg_oldpointer               ; re-select the old pointer number
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte
          ADD     sp, sp, #8
          LDMFD   sp!, {r4, r5, pc}

; Frame update - sets the hourglass shape for the current frame
; =>  R0 = hourglass workspace
hourglass_frame SIGNATURE
          EXPORT  hourglass_frame
          STMFD   sp!, {r4, r5, lr}
          MOV     r12, r0
          LDR     r0, hg_framenum
          ADRL    r1, frame_deltas
          LDR     r0, [r1, r0, LSL #2]            ; offset within deltas for this frame
          ADRL    r1, deltas
          ADD     r1, r1, r0
          ADRL    r2, rowdata
          ADRL    r5, hg_currentdata
rowloop
          LDMIA   r1!, {r3, r4}                   ; r3 = currentdata offset, row data offset
          CMP     r3, #-1                         ; end of the rows
          BEQ     rowend
          LDR     r0, [r4, r2]!                   ; read a word from rowdata
          STR     r0, [r3, r5]!                   ; store into the currentdata
      [ wordsperrow > 1
          LDR     r0, [r4, #4]!                   ; read a word from rowdata
          STR     r0, [r3, #4]!                   ; store into the currentdata
      ]
      [ wordsperrow > 2
          LDR     r0, [r4, #4]!                   ; read a word from rowdata
          STR     r0, [r3, #4]!                   ; store into the currentdata
      ]
      [ wordsperrow > 3
          LDR     r0, [r4, #4]!                   ; read a word from rowdata
          STR     r0, [r3, #4]!                   ; store into the currentdata
      ]
          B       rowloop

rowend
          MOV     r0, #21                         ; Set Pointer parameters
          ADR     r1, hg_word
          SWI     XOS_Word

          LDRB    r1, hg_word + 1                 ; get the hourglass pointer number we will use
          EOR     lr, r1, #1
          STRB    lr, hg_word + 1                 ; toggles the pointer number we use next time
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte

          LDR     r0, hg_framenum
          ADD     r0, r0, #1
          TEQ     r0, #nframes
          MOVEQ   r0, #0                          ; reset counter; we've cycled
          STR     r0, hg_framenum
          LDMFD   sp!, {r4, r5, pc}

; Frame update within an IRQ
; =>  R12 = hourglass workspace
hourglass_frame_irq SIGNATURE
          EXPORT  hourglass_frame_irq
          STMFD   sp!, {r0-r3, r4, r5, r12, lr}
          MOV     r0, r12
          MRS     r4, CPSR
          AND     r1, r4, #&F
          ORR     r1, r1, #&3
          MSR     CPSR_csxf, r1                    ; Enter SVC mode (keep bitness)
          MOV     r5, lr
          BL      hourglass_frame
          MOV     lr, r5
          MSR     CPSR_cxsf, r4                    ; Restore the mode
          LDMFD   sp!, {r0-r3, r4, r5, r12, pc}

          END
